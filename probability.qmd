# Probability {#sec-probability}

```{r}
#| include: false

source("_common.R")
```

```{r start-collecting-terms}
#| include: false
terms_chp_3 <- c("probability")

```


::: {.chapterintro data-latex=""}
Suppose a couple planning to have a child learns from genetic testing that they are both carriers of the gene that causes cystic fibrosis; they are unaffected but each have one copy of a gene containing mutations that confer the disease. What is the likelihood that they will have a child with cystic fibrosis?

If someone takes a rapid antigen self-test for COVID-19 and obtains a positive test result, how likely is it that they actually have the infection?

The rules of probability can be used to answer both questions. In some cases, probabilities can be calculated directly without formulas, while in others the rules and formulas for probability provide tools for breaking down complex problems into a series of simpler steps.
:::


## Two examples: genetic screening for cystic fibrosis and rapid antigen testing for COVID-19 {#sec-two-examples}

### Screening for cystic fibrosis {#sec-screening-cf}

Cystic fibrosis (CF) is a life-threatening genetic disorder caused by mutations in the *CFTR* gene located on chromosome 7. Defective copies of *CFTR* can result in a reduced quantity and function of the CFTR protein, leading to the buildup of thick mucus in the lungs and pancreas.^[The CFTR protein is responsible for transporting sodium and chloride ions across cell membranes.] CF is an autosomal recessive disorder; an individual only develops CF if they have inherited two affected copies of *CFTR*. Individuals with one normal (wild-type) copy and one defective (mutated) copy are known as *carriers*; they do not develop CF, but may pass the disease-causing mutation onto their offspring.

Suppose that both members of a couple are CF carriers. What is the probability that a child of this couple will be affected by CF? Assume that a parent has an equal chance of passing either gene copy to a child.

In @fig-cfInheritance, chromosomes with a mutated copy of *CFTR* are marked with a red bar and notated with a $-$. Each carrier has one mutated and one wild-type copy; thus, their genotype is $+/-$. The four possible genotypes for a child are shown in the lower right. The child is affected only if they have two mutated copies of *CFTR*. Since inheriting the mutated or  wild-type copy occurs with equal chance from each parent, each of the four outcomes occurs with equal likelihood. The probability that the child will have cystic fibrosis is 1/4.

```{r cf-inheritance}
#| label: fig-cfInheritance
#| out-width: 80%
#| fig-cap: |
#|   Pattern of CF inheritance for a child of two unaffected carriers.  Paternal chromosomes are depicted in green and maternal in blue. Chromosomes with CF mutations are denoted with a red horizontal band. There is a 1/4 chance of an unaffected child, 1/2 chance of a carrier, and 1/4 chance of a child with cystic fibrosis. 
#| fig-alt: |
#|   The pattern of cystic fibrosis inheritance for a child of two unaffected carriers. The figure uses colored chromosomes to show genetic combinations: green for paternal and blue for maternal. Red bands are used to mark the affected chromosomes. There are four possible outcomes. With a 1-in-4 chance, a child will receive a copy of an affected chromosome from each parent and have cystic fibrosis. 
#| fig-pos: H
knitr::include_graphics("images/cfInheritance.png")
```


```{r}
# ppv for covid RAT
# also used and repeated later
# 

sens_rat <- 0.80
spec_rat <- 0.98
prev_covid_05 <- 0.05

ppv_rat_05 <- round((sens_rat * prev_covid_05)/(sens_rat * prev_covid_05 + (1 - spec_rat) * (1 - prev_covid_05)), 2)
npv_rat_05 <- round(spec_rat * (1 - prev_covid_05) /(spec_rat * 1 - prev_covid_05 + (1 - sens_rat) * prev_covid_05), 2)

```

### Rapid self-tests for COVID-19 {#sec-rat-covid}

Since the COVID-19 pandemic, \index{rapid antigen tests (RAT)} rapid antigen tests (RAT) have been widely used as self-tests, allowing individuals to check for the virus on their own. These tests remain available at pharmacies, neighborhood health centers, libraries, and other distribution sites. They are convenient and either low-cost or free. But how reliable are the tests? More specifically, what is the chance that a positive result truly indicates infection, or that a negative result correctly confirms absence of infection?

Studies have shown that when 100 people with COVID-19 are tested using a nasal swab RAT, about 80 will test positive [@khalid2022performance]. The same studies have shown that when 100 people without the infection are tested, about 98 will test negative.  In the language of probability, the chance of a positive test is `r sens_rat` when the virus is present,  while the chance of a negative test in the absence of the virus is `r spec_rat`.  But an individual who has just tested is most interested in the *reverse* probabilities: the chance of being infected with COVID-19 when the test is positive or the chance of not having the infection when the test is negative. In other words, out of 100 people who test positive, how many actually have COVID-19? The tools in @sec-diagnostic-tests will show that even though the rapid self-tests are correct 80% of the time when the virus is present, under some assumptions a positive test might only be correct `r (ppv_rat_05) * 100`% of the time. 

## The rules and language of probability {#sec-probability-rules}

In both examples in @sec-two-examples, probability is used to quantify uncertainty about the **outcome** of a random phenomenon. However, these two examples differ in important ways.  In the first example, the set $S$ of all outcomes, called the **sample space**, \index{sample space} is a simple collection of 4 equally likely outcomes. The probability of a particular set of outcomes can be calculated by counting the relevant outcomes and dividing by the total number of outcomes in the sample space. The second example is more complex; it poses questions about the probability of an outcome under the condition that it has been preceded by another outcome (that is, the likelihood of infection when a self-test is known to be positive) and cannot easily be solved by the direct methods of the first example. More difficult problems need a general definition of probability and a set of rules to guide calculations.

### Defining probability {#sec-defining-probability}

::: {.important data-latex=""}
**Randomness and probability.**

A phenomenon is called random if the outcome of a single occurrence is uncertain, but the relative frequencies of different outcomes settle into stable proportions when many outcomes are observed.

The probability $p$ of an outcome for a random phenomenon is the long-run proportion of times the outcome occurs if the phenomenon is repeated many times under the same conditions.^[Another definition of probability is based on the subjective belief that an event will happen, but that approach is not covered in this text.]

:::

This is formalized in the Law of Large Numbers: when a random experiment is repeated many times, the observed proportion of an outcome converges to its true probability. For example, the probability of rolling a 1 on a fair six-sided die is 1/6. This does not mean that if the die is rolled 6 times, exactly one 1 will occur. However, if the die is rolled many times, the proportion of 1's will get closer to 1/6.

::: {.important data-latex=""}
**Sample spaces and events.**

The **sample space** $S$ of a random phenomenon is the set of all possible outcomes.  An **event** \index{event} $A$ is an outcome or a collection of outcomes.  It is a subset of the sample space, $S$.

:::

Each event can be thought of a *set* of outcomes. The relationships between events, such as "A and B", can then be described using language (and notation) from set theory. 

* The complement of an event $A$, written $A^c$, consists of all the outcomes in $S$ that are not in $A$. Together, $A$ and $A^c$ comprise all the events in $S$.

* The intersection of events $A$ and $B$, written as $(A \text{ and } B)$, consists of the outcomes that are in both $A$ and $B$. This can also be written as $A \cap B$.

* The union of events $A$ and $B$, which is commonly referred to as $(A \text{ or } B)$, consists of the outcomes that are either in $A$ or in $B$ or both. In probability, "or" is **inclusive**, meaning that the union includes outcomes where both $A$ and $B$ occur.

* Two events $A$ and $B$ are **disjoint** \index{disjoint events} if they have no outcomes in common. Such events can also be described as being **mutually exclusive** \index{mutually exclusive}.

* For conciseness, sentences such as "$B$ is the event that a child has CF" can be written as $B$ = {child has CF}. 

@fig-setTheoryNotation shows some events related to the possible outcomes when rolling a six-sided die: $A$ = {1, 2}, $B$ = {4, 6}, and $D$ = {2, 3}. 

* Since $A$ = {1, 2}, $A^c$ = {3, 4, 5, 6}. $S$ represents the set of all possible outcomes. 

* There is one shared outcome between $A$ and $D$: $(A \text{ and } D)$ = {2}. Thus, $A$ and $D$ are not disjoint whereas $A$ and $B$ are disjoint. 

* The union of $A$ and $D$ refers to $(A \text{ or } D)$ = {1, 2, 3}. 

```{r cf-inheritance}
#| label: fig-setTheoryNotation
#| out-width: 80%
#| fig-cap: |
#|   Diagram showing the possible outcomes when rolling one six-sided die and relationships between events.
#| fig-alt: |
#|   A diagram showing die faces labeled as outcomes 1 through 6. Three ovals represent different events: Event A includes dice showing 1 and 2; Event B includes dice showing 4 and 6; Event D includes dice showing 2 and 3. Event A and D overlap at outcome 2, showing a shared outcome, while Event B is separate, showing disjointness.
#| fig-pos: H
knitr::include_graphics("images/disjointEvents.png")
```



```{r}
terms_chp_3 <- c(terms_chp_3, c("sample space",
                                "outcome",
                                "event",
                                "disjoint events",
                                "mutually exclusive events",
                                "complement of an event")
)
```


::: {.workedexample data-latex=""} 

Suppose $A$ = {a child of two adults who both carry the CF gene is an unaffected carrier}.  Which members of the sample space belong to $A$?

------------------------------------------------------------------------

The event $A$ consists of the outcomes in the upper right and lower left of the boxes in @fig-cfInheritance showing the possible genotypes of a child.
:::


::: {.guidedpractice data-latex=""}

Suppose the random phenomenon of interest is rolling a single six-sided die.  Describe the sample space $S$, the event $A$ = {the outcome of the roll is an even number} and its complement $A^c$.  What is $P(A)$?
[^probability-1]
:::

[^probability-1]: $S$ = {1, 2, 3, 4, 5, 6}, $A$ = {2, 4, 6} and $A^c$ = {1, 3, 5}.  $A^c$ is the event of rolling an odd number.  $P(A)$ = 3/6.

::: {.guidedpractice}
When rolling a six-sided die, are the events $A$ = {the outcome is an even number} and $B$ = {the outcome is smaller than 4} disjoint? Describe the event ($A \text{ and } B$) and the event $(A \text{ or } B)$.  What are $P(A \text{ and } B)$ and $P(A \text{ or } B)$?
[^probability-2]
:::

[^probability-2]: No, the two events have the outcome 2 in common. $(A \text{ and } B)$ = {2} while $(A \text{ or } B)$ = {1, 2, 3, 4, 6}. $P(A \text{ and } B)$ = 1/6; and $P(A \text{ or } B)$ 5/6.

::: {.workedexample data-latex=""}

What is the sample space corresponding to the random process of rolling two six-sided dice and recording the value of the faces showing?  What is the probability that the sum is equal to 3?

------------------------------------------------------------------------

There are 6 possible outcomes for the first die, and for each of those outcomes there are 6 possible outcomes for the second die, so the sample space consists of the 36 ordered pairs $(j,k)$, where $j$ and $k$ can be any of the integers between 1 and 6.  There are two outcomes where the sum is 3, (1,2) and (2,1), and each outcome is equally likely, so the probability that the sum is 3 is 2/36.
:::

::: {.guidedpractice data-latex=""}

Describe the event $A$ = {the sum of dice is 4} when rolling two dice.  What is $P(A)$?  [^probability-101]
:::

[^probability-101]: $A$ = {$(1,3), (2,2), (3,1)$}; $P(A)$ = 3/36.

### The properties of probability {#sec-probability-properties}

The properties of probability summarized below have already been used implicitly in the dice rolling example.


::: {.important data-latex=""}
**The properties of probability.**

**Probability of the sample space S:** If $S$ is the sample space of a random phenomenon, $P(S) = 1.$

**Boundedness:** The probability $P(A)$ of any event satisfies $0 \leq P(A) \leq 1.$

**Addition rule for disjoint events:**  If $A$ and $B$ are disjoint events,
$$
P(A \text{ or } B) = P(A) + P(B).
$$
If $A_1, A_2, \ldots A_k$ are a collection of $k$ disjoint events,
$$
P(A_1 \text { or } A_2 \ldots \text{ or } A_k) = P(A_1) + P(A_2) + \dots + P(A_k).
$$
**Complement rule:**  For any event $A$
$$
P(A^c) = 1 - P(A).
$$
:::

If no outcomes satisfy an event $A$, it cannot occur and $P(A)$ = 0. As a consequence, if $A$ and $B$ are disjoint events, $P(A \text{ and } B)$ = 0.

```{r}
terms_chp_3 <- c(terms_chp_3, c("Venn diagram",
                                "properties of probability",
                                "addition rule for disjoint events",
                                "complement rule")
)               
```

The next section uses the General Social Survey to illustrate probability in a more realistic setting.

### Example: The General Social Survey {#sec-gss-example}

```{r load-gss}
load("./data/gss_df.Rdata")
load("./data/gen_ss.Rdata")
```


The \index{General Social Survey} General Social Survey is conducted by the National Opinion Research Center (NORC) at the University of Chicago.  The survey collects data on American society by asking demographic, behavioral, and attitudinal questions along with some topics of special interest and has been conducted approximately every two years since 1972. @tbl-gss-age-health shows  `r nrow(gen_ss)` total responses to two selected variables from respondents participating in surveys conducted between 2018 and 2024, classified according to the age of the respondent and self-perception of their general health.^[The data in this and similar tables later in the text do not include missing values from non-response since methods for adjusting for missing values are beyond the scope of this text. Accordingly, the data in the table should not used to estimate population parameters.]  

```{r tbl-gss-age-health}
#| label: tbl-gss-age-health
#| tbl-cap:  "Counts of health rating and age group"
#| tbl-pos: H
gen_ss |> 
  select(age_group, 
         health_status) |> 
  count(age_group, health_status) |> 
  group_by(age_group) |> 
  pivot_wider(names_from = health_status, 
              values_from = n) |> 
  adorn_totals(where = c("row", "col"), name = "Sum") |> 
  kbl(linesep = "",
      booktabs = TRUE) |> 
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"),
    full_width = FALSE) |>
  add_header_above(c("Age " = 1, "Health rating" = 5)) |>
  column_spec(1, width = "4em") |>
  column_spec(2:6, width = "4em") |> 
  column_spec(6, bold = TRUE) |> 
  row_spec(5, bold = TRUE) 
  
```


```{r gss-age-health-elements, echo = FALSE}
df <- gen_ss

t <- table(df$age_group, df$health_status)
tbl_age_health <-  addmargins(t)
tbl_age_health_prop <- round(addmargins(prop.table(t)),3)


```



::: {.workedexample data-latex=""}

Suppose that a researcher plans to sample a case randomly from the `r nrow(gen_ss)` in this dataset to conduct an additional interview using contact information in a separate confidential file.  (a) What is the sample space for this process?  (b) Which outcomes belong to the event $A$ = {a respondent said they were older than 25}?  How many responses satisfy $A$? What is $P(A)$?  (c) Let $B$ be the event of sampling a respondent who rated their health rating good.  What is $P(A \text{ and } B)$? 

------------------------------------------------------------------------

(a)  The sample space consists of the `r nrow(gen_ss)`  cases in the dataset.

(b) The event $A$ consists of a response in one of the 3 older age groups, 26 to 45, 46 to 65, and 65+.  The total number of outcomes is the sum of the number of respondents listed in the **Sum** column for the  3 corresponding rows, or `r tbl_age_health[2,5] + tbl_age_health[3, 5] + tbl_age_health[4, 5]`.  $P(A)$ = `r tbl_age_health[2,5] + tbl_age_health[3, 5] + tbl_age_health[4, 5]` / `r nrow(gen_ss)` = `r round((tbl_age_health[2,5] + tbl_age_health[3, 5] + tbl_age_health[4, 5]) / nrow(gen_ss), 3)`. $A^c$ consists of sampling a case from the `r tbl_age_health[1, 5]` cases in the first row, and since $P(A) = 1 - P(A^c)$, $P(A)$ can also be calculated as 1 - `r tbl_age_health[1,5]`/ `r nrow(gen_ss)` = `r round(1 - tbl_age_health[1,5]/nrow(gen_ss), 3)`.


(c) The number of outcomes satisfying $(A \text{ and } B)$ is the sum of the counts in rows 2, 3 and 4 of column 2, or `r tbl_age_health[2,2] + tbl_age_health[3, 2] + tbl_age_health[4, 2]`.  So $P(A \text{ and } B)$ =  `r round((tbl_age_health[2,2] + tbl_age_health[3, 2] + tbl_age_health[4, 2]) / nrow(gen_ss), 3)`.
::: 

::: {.guidedpractice data-latex=""}

For the events $A$ and $B$ defined above, describe the events $(A \text{ or } A^c)$ and $(A^c \text{ and } B)$.  How many outcomes are in each? [^probability-3]
:::

[^probability-3]: The event $(A \text{ or } A^c)$ consists of all  `r nrow(gen_ss)` cases in the dataset. $(A^c \text{ and } B)$ consists of the `r  tbl_age_health[1,2]` respondents who are age 18 - 25 and rated their health as good.  


@tbl-gss-age-health-prop displays the data from @tbl-gss-age-health but with proportions replacing counts; the proportions in each cell give the fraction of the observations in the cell when the counts have been divided by the size of the dataset, `r nrow(gen_ss)`, and can be used to calculate probabilities directly.  For instance, the value 0.019 in the upper left cell is the proportion of individuals age 18 to 25 and reporting excellent health, or `r tbl_age_health[1,1]` / `r tbl_age_health[5,5]`; this can also be interpreted as the probability of randomly sampling an individual who reports their health as excellent and is in the 18 to 25 age group. 

```{r tbl-gss-age-health-prop}
#| tbl-cap:  "Heath rating and age group, with counts replaced by proportions"
#| tbl-pos: H
#| label: tbl-gss-age-health-prop
gen_ss |> 
  select(age_group, 
         health_status) |> 
  count(age_group, health_status) |> 
  mutate(prop = n /sum(n)) |> 
  select(-n) |> 
  pivot_wider(names_from = health_status, 
              values_from = prop,
              values_fill = 0) |> 
  adorn_totals(where = c("row", "col"), name = "Sum") |> 
  kbl(linesep = "",
      booktabs = TRUE) |> 
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"),
    full_width = FALSE) |>
  add_header_above(c("Age " = 1, "Health rating" = 5)) |>
  column_spec(1, width = "4em") |>
  column_spec(2:5, width = "4em") |> 
  column_spec(6, bold = TRUE) |> 
  row_spec(5, bold = TRUE) 
  
```

@tbl-gss-age-health-prop illustrates the first two rules of probability: the sum of all the probabilities is 1, and all values in the table are between 0 and 1.  

In this example of sampling from the GSS data, @tbl-gss-age-health-prop shows the **probability distribution** for each of the possible outcomes in the sample space that are characterized by the age and health rating of a respondent.

::: {.important data-latex=""}
**Probability distribution.**

A probability distribution consists of all outcomes in a random process and their associated probabilities.

:::

```{r}
terms_chp_3 <- c(terms_chp_3, c("probability distribution")
)               
```


### Venn diagrams {#sec-venn-diagrams}

**Venn diagrams** \index{Venn diagrams} are often used to visualize the relationship between events in a sample space. The Venn diagram in @fig-gss-older-health-venn shows the relationship between the events $A$ and $B$ in the above example. It has less information than the full table, but provides a visual display of the overlap between $A$ and $B$. The total possible outcomes belonging to A equals $5071 + 5844$, which represents the members belonging to $A$ but not to $B$ and the members belonging to both $A$ and $B$. The number of members in $B$ is calculated similarly. The 417 outcomes outside the two circles represents the members of the sample space not in either event.  The percentages shown in the figure can be converted to proportions to calculate the probabilities of regions in the figure; for example, the probability of $A$ is 0.432 + 0.498 = 0.930. 

```{r, include = FALSE}
# trying out a helper function to add sample space box

library(ggvenn)
library(ggplot2)

# Helper to read x/y ranges across ggplot2 versions
.range_from_panel <- function(pp, axis = c("x", "y")) {
  axis <- match.arg(axis)
  # Older ggplot2 (e.g., 3.3.x)
  rng1 <- pp[[paste0(axis, ".range")]]
  if (!is.null(rng1)) return(rng1)
  # Newer ggplot2 (e.g., 3.4+)
  rng2 <- try(pp[[axis]]$range$range, silent = TRUE)
  if (!inherits(rng2, "try-error") && !is.null(rng2)) return(rng2)
  # Fallback
  rng3 <- try(pp[[axis]]$range, silent = TRUE)
  if (!inherits(rng3, "try-error") && !is.null(rng3)) return(rng3)
  stop("Could not determine ", axis, " range from panel_params.")
}

add_sample_space <- function(p, expand = 0.05, color = "black", linewidth = 1) {
  gb <- ggplot_build(p)
  pp <- gb$layout$panel_params[[1]]

  xr <- .range_from_panel(pp, "x")
  yr <- .range_from_panel(pp, "y")

  xpad <- diff(range(xr)) * expand
  ypad <- diff(range(yr)) * expand

  p + annotate(
    "rect",
    xmin = xr[1] - xpad, xmax = xr[2] + xpad,
    ymin = yr[1] - ypad, ymax = yr[2] + ypad,
    fill = NA, color = color, linewidth = linewidth
  )
}

```


```{r older-health-venn}
#| label: fig-gss-older-health-venn
#| out-width: 80%
#| fig-cap: | 
#|     Venn diagram showing the overlap between the events {older than age 25} and {health rating good}.  
#| fig-alt: |
#|   A Venn diagram consisting of a blue circle and a red circle with an overlapping area. The blue circle represents event A and the red circle represents event B. The overlapping area is labeled 5,844. The blue area that does not overlap is labeled 5,071 and the red area that does not overlap is labeled 402. The Venn diagram is within a rectangle; the label 417 appears inside the rectangle but outside the Venn diagram.

`Older than 25 (A)` <- (gen_ss$age_group != "18 to 25") 
`Health rating good (B)` <- (gen_ss$health_status == "good")
d <- data_frame(`Older than 25 (A)`, `Health rating good (B)`)

library(ggvenn)
p <- ggvenn(d, 
            fill_color = c(IMSCOL["blue", "full"], IMSCOL["red", "full"]),
            set_name_size = 4,
            auto_scale = FALSE)

add_sample_space(p) 
```

::: {.workedexample data-latex=""}

In the context of what the events $A$ and $B$ represent, describe the 417 outcomes represented by the white space outside the circles in @fig-gss-older-health-venn.

------------------------------------------------------------------------

The cases represented by the white space in the figure are those who are both 25 or younger and rated their health as other than good.

:::




::: {.workedexample data-latex=""}

Using the probabilities in @tbl-gss-age-health-prop and the rules of probability, find (a) the probability that someone chosen from this cohort rated their health as good, and (b) the probability that they rated their health as other than good.

------------------------------------------------------------------------

(a) The probability of being in good health is the sum of the probabilities in the second column, which is 0.532 as shown in the last row.  More formally, the event $B$ = {health rated good} is a combination of disjoint events:
$$
B = (D_1 \text{ or } D_2 \text{ or } D_3 \text{ or } D_4), 
$$
where   
    - $D_1$ = ({health rated good} and {age between 18 and 25})     
    - $D_2$ = ({health rated good} and {age between 26 and 45})      
    - $D_3$ = ({health rated good} and {age 56 to 65}} and     
    - $D_4$ = ({health rated good} and {age 66+}). 

Thus
$$
P(B) = P(D_1) + P(D_2) + P(D_3) + P(D_4). 
$${#eq-prob-good-health}

When probabilities are calculated by summing rows or columns in a table, it is generally not necessary to write out the algebra in @eq-prob-good-health since the application of the addition rule is clear.

(b) If $H$ = {other than good health}, then $H = B^c$, so 
$$
P(H) = 1 - P(B) = 1 - 0.532 =0.477.
$$
A little less than 50% of this cohort rated their health as other than good.

As always, it pays to be careful with the language in a problem statement. While a phrase such as "not good" might only be interpreted as only referring to fair or poor, saying "other than good" more explicitly specifies that excellent, fair, and poor all belong to $H$.

:::

### The Law of Total Probability {#sec-lotp}

The solution to (a) in the problem in the last section implicitly used another probability rule, the law of total probability, by breaking the event $B$ into disjoint chunks.  Here is a formal statement of the rule:

::: {.important data-latex=""}

**The law of total probability (LOTP).**

Suppose $A$ and $B$ are events in a sample space.  Then
$$ 
P(B) = P(B \text{ and } A) + P(B \text{ and } A^c).
$${#eq-total-probability}
More generally, let $E_1, E_2, \ldots, E_k$ be $k$ disjoint events that cover the sample space, so $(E_1 \text{ or } E_2 \cdots \text{ or } E_k) = S$. Then 
$$
P(B) = P(B \text{ and } E_1) + P(B \text{ and } E_2) + \cdots  + P(B \text{ and } E_k).
$${#eq-general-total-probability}

:::

@fig-lotp-general-venn uses a Venn diagram to illustrate the LOTP.

```{r}
#| label: fig-lotp-general-venn
#| out-width: 60%
#| fig-cap: | 
#|     Diagram illustrating how to solve for the probability of an event $B$ by breaking the event into 
#|     disjoint events according to another three events $E_1, E_2$ and $E_3$. 
#| fig-alt: |
#|      A large rectangle represents the sample space S, which is divided vertically into three disjoint events, $E_1$, $E_2$, and $E_3$. An oval labeled B overlaps all three regions, representing event B. The overlapping shaded regions inside the oval represent the three possible intersections of B with the three partitions of E. The area of B can be found by summing the area inside the oval that is divided by the vertical lines.  
#|     
#| 

library(grid)
library(ggforce)

# --- canvas & partition ---
xlim <- c(0, 10)
ylim <- c(0, 6)
cuts <- c(3, 7)

# diagonal hatch lines over the sample space
step <- 0.35
t <- seq(-ylim[2], xlim[2], by = step)
hatch <- data.frame(
  x    = t,
  xend = t + ylim[2],
  y    = 0,
  yend = ylim[2]
)

# ellipse (event B)
B <- data.frame(x0 = 5.0, y0 = 3.0, a = 4.0, b = 2.4, angle = 0)

ggplot() +
  # sample space border
  geom_rect(aes(xmin = xlim[1], xmax = xlim[2], ymin = ylim[1], ymax = ylim[2]),
            fill = NA, color = "black", linewidth = 1) +
  # hatch
  geom_segment(data = hatch,
               aes(x = x, xend = xend, y = y, yend = yend),
               color = "#5DADE2", alpha = 0.25, linewidth = 0.6) +
  # event B
  geom_ellipse(data = B,
               aes(x0 = x0, y0 = y0, a = a, b = b, angle = angle),
               fill = "#2E86C1", alpha = 0.35, color = "#2E86C1", linewidth = 1) +
  # partition lines
  geom_segment(aes(x = cuts[1], xend = cuts[1], y = ylim[1], yend = ylim[2]),
               color = "black", linewidth = 0.7) +
  geom_segment(aes(x = cuts[2], xend = cuts[2], y = ylim[1], yend = ylim[2]),
               color = "black", linewidth = 0.7) +
  # labels
  annotate("text", x = 2.2, y = 3.1, label = "B ~ and ~ E[1]", size = 6, parse =  TRUE) +
  annotate("text", x = 5.0, y = 3.1, label = "B ~ and ~ E[2]", size = 6, parse = TRUE) +
  annotate("text", x = 8.2, y = 3.1, label = "B ~ and ~ E[3]", size = 6, parse = TRUE) +
  annotate("text", x = 1.0, y = 0.35, label = "E[1]", size = 6, parse = TRUE) +
  annotate("text", x = 5.0, y = 0.35, label = "E[2]", size = 6, parse = TRUE) +
  annotate("text", x = 8.0, y = 0.35, label = "E[3]", size = 6, parse = TRUE) +
  annotate("segment", x = 9.2, y = 5.5, xend = 7.5, yend = 4.9,
           arrow = arrow(length = unit(0.25, "cm")), linewidth = 0.7) +
  annotate("text", x = 8.8, y = 5.8, label = "Event B", hjust = 0, size = 5) +
  coord_fixed(xlim = xlim, ylim = ylim, expand = FALSE) +
  theme_void()
```


::: {.workedexample data-latex=""}

Suppose that approximately 7/100 adults in the US have diabetes and do not have cardiovascular disease, while 5/100 adults have both diabetes and cardiovascular disease.  What fraction of US adults have diabetes?

------------------------------------------------------

Let $B$ = {an individual has diabetes} and $A$ = {an individual has cardiovascular disease}. Then $P(B \text{ and } A^c) = 0.07$ while $P(B \text{ and } A) = 0.05.$  Using the rule of total probability in @eq-total-probability,
$$
P(B) =  P(B \text{ and } A) + P(B \text{ and } A^c) = 0.12.
$$
These data suggest that about 12% of adult Americans have diabetes.
:::

```{r ex-deg_wrk_status}
t = addmargins(prop.table(table(gen_ss$degree_status, gen_ss$work_status)))

t <- round(t, 3)
```

::: {.guidedpractice data-latex=""}

The prevalence of a disease is the probability that a member of a population has the disease.  Parkinson's disease (PD) is a neurodegenerative disorder with a prevalence that varies with age.  Studies have shown that in low- to upper-middle-income countries the age-related prevalence of PD is estimated to be 7 per 100,000 for individuals age 40 - 49, 158 per 100,000 in age 50 - 59, 603 per 100,000 in age 60 - 79, 1251 in age 70 - 79,and 2181 per 100,000 in age over 80. [@pereira2024systematic]  Assuming that the disease is so rare in individuals who are younger than 40 that the prevalence in that age group can be considered 0, what is the overall prevalence of PD?
[^probability-4]

:::

[^probability-4]: Using the general form of the law of total probability, the prevalence of PD is 
$$
\frac{1}{100000}(7 + 158 + 603 + 1251 + 2181) = `r 7 + 158 + 603 + 1251 + 2181`/100,000 = 0.042. 
$$

::: {.guidedpractice data-latex=""}

@tbl-gss-deg-work-prop from the General Social Survey shows the probabilities of work status and highest degree attained in school. What is the probability that (a) a respondent is working full or part time; (b) a respondent has a bachelor's or graduate degree; (c) has a bachelor's degree or higher and is unemployed or retired?
[^probability-5]
:::

[^probability-5]: (a) The probability is the sum of the elements in the first two columns, `r t[6,1] + t[6,2]`; (b) the sum of the last two rows, `r t[4,9] + t[5,9]`; (c) the sum of the values in the intersection of the last two rows and the columns for unemployed and retired, `r t[4,4] + t[4,5] + t[5,4] + t[5,5]`.


```{r tbl-gss-deg-work-prop}
#| label: tbl-gss-deg-work-prop
#| tbl-cap:  "Work status and highest degree earned"
#| tbl-pos: H
gen_ss |> 
  select(work_status, 
         degree_status) |> 
  count(work_status, degree_status) |> 
  mutate(prop = n /sum(n)) |> 
  select(-n) |> 
  pivot_wider(names_from = work_status, 
              values_from = prop,
              values_fill = 0) |> 
  kbl(linesep = "",
      booktabs = TRUE) |> 
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"),
    full_width = FALSE) |>
  add_header_above(c("Highest degree " = 1, "Work status" = 8)) |>
  column_spec(1, width = "5em") |>
  column_spec(2:8, width = "4em") 
  
  
```
```{r}
terms_chp_3 <- c(terms_chp_3, c("law of total probability (LOTP)")
)               
```

### The general addition rule {#sec-general-addition-rule}

Now, consider the events $B$ = {health rating good} and $E$ = {respondent is age 26 - 45}. The probability $P(B \text{ and } E)$ is `r tbl_age_health_prop[2,2]`, shown in the intersection of the shaded rows in @tbl-gss-age-health-prop-shaded. 

What about $P(B \text{ or }E)$, as shown by the shaded cells in @tbl-gss-age-health-prop-shaded? The events $B$ and $E$ are not disjoint so the addition rule for disjoint events does not apply. Adding together the sums of the second row and second column (`r  tbl_age_health_prop[2,5] + tbl_age_health_prop[5,2]`) includes $P(B \text{ and } E)$ twice, so it must be subtracted once:
\begin{align*}
P(B \text{ or } E) &= P(B) + P(E) - P(B \text{ and } E) \\
    &= `r tbl_age_health_prop[2,5]` + `r tbl_age_health_prop[5,2]` - `r tbl_age_health_prop[2,2]` \\
    &= `r tbl_age_health_prop[2,5] + tbl_age_health_prop[5,2] - tbl_age_health_prop[2,2]`.
\end{align*}


```{r tbl-gss-age-health-prop-shaded}
#| label: tbl-gss-age-health-prop-shaded
#| tbl-cap:  "Health rating and age group, with counts replaced by proportions"
#| tbl-pos: H
gen_ss |> 
  select(age_group, 
         health_status) |> 
  count(age_group, health_status) |> 
  mutate(prop = n /sum(n)) |> 
  select(-n) |> 
  pivot_wider(names_from = health_status, 
              values_from = prop,
              values_fill = 0) |> 
  adorn_totals(where = c("row", "col"), name = "Sum") |> 
  kbl(linesep = "",
      booktabs = TRUE) |> 
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"),
    full_width = FALSE) |>
  add_header_above(c("Age " = 1, "Health rating" = 5)) |>
  column_spec(1, width = "4em") |>
  column_spec(2:5, width = "4em") |> 
  column_spec(6, bold = TRUE) |> 
  row_spec(5, bold = TRUE) |> 
  row_spec(2, background = "gray") |> 
  column_spec(3, background = "gray")
  
```


The calculation of $P(B \text{ or } E)$ illustrates the General Addition Rule:

::: {.important data-latex=""}
**General addition rule**

If $A$ and $B$ are any two events, disjoint or not, then the probability that at least one of them will occur is
$$
P(A\text{ or }B) = P(A) + P(B) - P(A\text{ and } B),
$$ {#eq-general-addition-rule}
where $P(A \text{ and } B)$ is the probability that both events occur.

:::

```{r}
terms_chp_3 <- c(terms_chp_3, c("general addition rule of probability")
)               
```


The idea behind the general addition rule can also be visualized in @fig-gss-age-health-venn, a Venn diagram showing the relationship between the events {age 26 to 45} and {health rating good}. The figure shows that there are 1896 + 2180 = 4076 outcomes in the event {age 26 to 45} and 4066 + 2180 = 6246  in the event {health rating good}. Simply adding the sums for each event, 4076 + 6246 = 10322, double counts the 2180 in the overlap. Instead, the number of outcomes in ({age 26 to 45} or {health rating good}) is 4076 + 6246 - 2180 = 8146.


```{r fig-gss-age-health-venn}
#| label: fig-gss-age-health-venn
#| out-width: 80%
#| fig-cap: | 
#|     Venn diagram showing the overlap between the events {age 26 to 45} and {health rating good}. The two events are not disjoint.  
#| fig-alt: |
#|   A Venn diagram consisting of a blue circle and a red circle with an overlapping area. The blue circle represents event {Age 26 to 45} and the red circle represents event {Health rating good}. The overlapping area is labeled 2,180. The blue area that does not overlap is labeled 1,896 and the red area that does not overlap is labeled 4,066. The Venn diagram is within a rectangle; the label 3,592 appears inside the rectangle but outside the Venn diagram.

`Age 26 to 45` <- (gen_ss$age_group == "26 to 45") 
`Health rating good` <- (gen_ss$health_status == "good")
d <- data_frame(`Age 26 to 45`, `Health rating good`)

library(ggvenn)
p <- ggvenn(d, 
            fill_color = c(IMSCOL["blue", "full"], IMSCOL["red", "full"]),
            set_name_size = 4,
            auto_scale = FALSE)

add_sample_space(p)

```





::: {.guidedpractice data-latex=""}

(a) Use @fig-gss-age-health-venn to calculate $P${age 26 to 45} and $P${health rating good}. (b) Confirm that the Venn diagram does indeed include all outcomes in the sample space  [^probability-6]
:::

[^probability-6]: (a) $P(\text{age 26 to 45}) = 0.162 + 0.186 = `r 0.162 + 0.186`$. $P(\text{health rating good}) = 0.186 + 0.347 = `r 0.186 + 0.347`$.
(b) The total outcomes shown in the figure is 1896 + 2180 + 4066 + 3592 = `r 1896 + 2180 + 4066 + 3592`, which is the size of the dataset.



::: {.workedexample data-latex=""}

```{r}
t <- tbl_age_health_prop
```

Use the general addition rule and @tbl-gss-age-health-prop to calculate that someone is either 66 years or older or has rated their health as poor.  

-----------------------------------------
Let $A$ = {age 66+} and $F$ = {health rating poor}. Using @eq-general-addition-rule,

\begin{align*}
 P(A \text{ or } F) &= P(A) + P(F) - P(A \text{ and } F) \\
                    &= `r t[4,5]` + `r t[5,4]` - `r t[4,4]` \\ 
                    &= `r t[4,5] + t[5,4] - t[4,4]`.
\end{align*}

:::

::: {.guidedpractice data-latex=""}

Using @tbl-gss-age-health-prop, what is the probability that (a) someone is older than age 46 and rates their health as poor and (b) they are either older than 46 or have rated their health as poor?  [^probability-8]

:::

[^probability-8]: Let $H$ = {age older than 46} and $F$ defined as above. (a) 
\begin{align*}
P(H \text{ and } F) &= `r t[3,4]` + `r t[4,4]` \\
                    &= `r t[3,4] +  t[4,4]`. 
\end{align*}
(b) 
\begin{align*} 
P(H \text{ or } F) &= P(H) + P(F) - P(H \text{ and } F) \\ 
                   &= `r t[3,5] +  t[4,5]` + `r t[5,4]` - `r (t[3,4] + t[4,4])` \\
                   &= `r t[3,5] +  t[4,5] +  t[5,4] -  (t[3,4] + t[4,4])`.
\end{align*}


## Conditional probability {#sec-conditional-probability}

Estimates of probability may change once new information is available. Probabilities that once described the whole population may no longer apply once additional context is known. For example, about 11.6\% of people in the United States have been diagnosed with diabetes, so if a person is selected at random, the probability that they have diabetes is 0.116, or about 0.12.^[https://www.cdc.gov/diabetes/php/data-research/index.html] 

But, suppose we learn that the selected individual is 65 years old or older; i.e., in an age group that is at higher risk for diabetes. Among American adults 65 and older, about 24.4\% have been diagnosed with diabetes. Now, the relevant probability is no longer the overall prevalence of diabetes but the prevalence given age. 

Incorporating the person's age, or in other words, *conditioning* on age, allows for a more precise estimate of the probability that the person has diabetes.

::: {.important data-latex=""}
**Conditional probability.**

Let $A$ and $B$ be two events.  The conditional probability of $B$ given $A$, written $P(B | A)$, is the probability of $B$ occurring if it is known that $A$ has occurred.  

:::

If $B$ is the event that someone has diabetes and $A$ is the event that they are 65 or older, then
$$
P(B) = 0.12,
$$
while 
$$
 P(B \mid A) = 0.24,
$$
The probability of diabetes is different conditional on age group. 

### Example: Conditional probabilities in the GSS data {#sec-conditional-prob-gss}

Conditional probabilities can be calculated from tables such as @tbl-gss-age-health. Suppose $A$ = {age 26 to 45}.  Conditioning on the event $A$ = {age 26 to 45} means calculating probabilities for reported health specifically among the `r tbl_age_health[2,5]` respondents in that age group. For instance, 

$$
P(\text{health rating = good} | A) =  \frac{`r tbl_age_health[2,2]`}{`r tbl_age_health[2,5]`} = `r tbl_age_health[2,2]/ tbl_age_health[2,5]`.
$$
@tbl-gss-age-health-row-prop shows the probabilities of each health rating conditional on age, which are equal to row proportions calculated from @tbl-gss-age-health. These can also be described as conditional distributions for health rating based on age. Comparing the rows of the table shows how the conditional probabilities of health rating vary with age. For example, while "good" is the most commonly reported health rating within each age group, the table indicates how "excellent" is less commonly reported among older individuals compared to younger individuals.

Notice how conditional probabilities are simply probabilities re-calculated in a subset of the original sample space. In any given row, all the probabilities are between 0 and 1 and sum to 1. 

```{r tbl-gss-age-health-row-prop}
#| label: tbl-gss-age-health-row-prop
#| tbl-cap:  "Row proportions for heath rating by age group"
#| tbl-pos: H
gen_ss |> 
  select(age_group, 
         health_status) |> 
  count(age_group, health_status) |> 
  group_by(age_group) |> 
  mutate(proportion = n / sum(n)) |>
  dplyr::select(-n)  |> 
  pivot_wider(names_from = health_status, 
              values_from = proportion) |> 
  adorn_totals(where = c("col"), name = "Sum") |> 
  kbl(linesep = "",
      booktabs = TRUE,
      digits = 3) |> 
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped"),
    full_width = FALSE) |>
  add_header_above(c("Age " = 1, "Health rating" = 5)) |>
  column_spec(1, width = "4em") |>
  column_spec(2:6, width = "4em") 
```

While Tables [-@tbl-gss-age-health-prop] and [-@tbl-gss-age-health-row-prop] appear similar, the values have different interpretations:  

  * In @tbl-gss-age-health-prop, the value in the second row, second column (`r tbl_age_health_prop[2,2]`) is $P$({age 26 to 45} and {health rating good}). This is the proportion of respondents who are age 26 to 45 **and** reported a good health status out of all 11,734 respondents and is called a \index{joint probability} **joint probability** for the two outcomes.
  
  * In @tbl-gss-age-health-row-prop, the value in the second row, second column (0.535) is $P$({health rating good} | {age 26 to 45}). This is a  \index{conditional probability} **conditional probability**, the proportion of respondents rating their health good out of the `r tbl_age_health[2,5]` respondents who are age 26 to 45. 

In @tbl-gss-age-health-prop, the row sums in the last column show the probability of an age group among the respondents, regardless of health status; the column sums in the last row show the probabilities of health rating, regardless of age.  These probabilities are called **marginal probabilities** \index{marginal probability} for health rating and age.  


### Formula for conditional probability

The earlier example showing the calculation for a row proportion points to a general approach for calculating conditional probabilities. 

Suppose that $A$ = {Age 26 to 45} and $B$ = {Health rating good}. The element in @tbl-gss-age-health-row-prop corresponding to $P(B \mid A)$ can be calculated as

\begin{aligned}
P(B \mid A) 
  &= \frac{\text{number of outcomes in } (B \text{ and } A)}{\text{number of outcomes in } A} \\
  &= \frac{2180}{4076} \\
  &= 0.535
\end{aligned}

Equivalently, it can also be calculated from the joint probability and the marginal probability of $B$, rather from directly using the counts.

\begin{aligned}
P(B \mid A) 
  &= \frac{\text{number of outcomes in } (B \text{ and } A) /{\text{total outcomes}}}
          {\text{number of outcomes in } A / {\text{total outcomes}}} \\
  &= \frac{P(B \text{ and } A)}{P(A)} \\
  &= \frac{0.1858}{0.3473} \\
  &= 0.535
\end{aligned}

::: {.important data-latex=""}
**Formula for conditional probability.**

Suppose $A$ and $B$ are events in a sample space.  Then as long as $P(A) > 0$
$$
  P(B \mid A) = \frac{P(B \text{ and } A)}{P(A)}.
$$ {#eq-conditional-probability}

:::

```{r}
terms_chp_3 <- c(terms_chp_3, c("conditional probability",
                                "prevalence",
                                "joint probability",
                                "marginal probability")
)               
```


In many texts @eq-conditional-probability serves as the definition of conditional probability.  In this text, @eq-conditional-probability is viewed as a way to calculate a conditional probability based on the conceptual definition given earlier.


A simple rearrangement of the the formula for conditional probability yields the multiplication rule.

::: {.important data-latex=""}
**Multiplication rule**

If $A$ and $B$ are two events in a sample space, then
$$
P(B\text{ and } A) = P(B | A)P(A).
$${#eq-mult-rule-two-probs}
::: 
 
::: {.workedexample data-latex=""}

Suppose that among adults age 25 to 40 years who consume a high sodium diet, hypertension occurs about 18% of the time. Assume that 60\% of adults in this age group consume a high-sodium diet. What is the probability of randomly selecting an adult in this age group who has hypertension and consumes a high-sodium diet?

------------------------------------------------------------------------

Let $A$ be the event that a person in this age group has hypertension and $B$ the event that a person in this age group consumes a high-sodium diet. $P(A|B)$, the probability of hypertension given high-sodium diet, is 0.18. Thus, $P(A \text{ and } B) = (0.18)(0.60) = 0.108$.
:::

::: {.workedexample data-latex=""}

In the United States, younger people are more likely to rent their home than other age groups. Approximately 65\% of residents who are age 35 or younger rent, while 42\% of older residents rent. Suppose that about 30\% of the U.S. population are age 35 or younger.

(a) Draw a Venn diagram showing the relationship between the events {age 35 or younger} and {rents their home}, showing the probabilities of the non-overlapping regions.

(b) Use the information in the Venn diagram to compute the probability that someone who rents their home is age 35 or younger.

(c) Explain the difference between the quantity calculated in part b. and the probability that a randomly sampled person who is age 35 or younger rents their home. Use terms that someone without a background in statistics would understand.

------------------------------------------------------------------------

Let $A$ = {randomly selected person is age 35 or younger}, and $R$ = {randomly selected person rents their home}. From the problem statement, $P(R \mid A)$ = 0.65, $P(R \mid A^c)$ = 0.042, and $P(A)$ = 0.30. 

(a) @fig-rent-35younger-venn-blank shows an initial Venn diagram which shows the relationship between the events $A$ and $R$, but without the probabilities. Since $P(R|A) > 0$, there will be an overlap between the events. The white space surrounding the circles represents individuals who are older than 35 years and who do not rent their home. 

```{r, include = FALSE}
# trying helper for plots from VennDiagram 

# Add a border that matches the VennDiagram grob's own viewport (the white box)
add_vd_border <- function(g,
                          pad = unit(0, "mm"),   # inset the frame if you want
                          col = "black",
                          lwd = 2,
                          draw_under = FALSE) {

  vp <- if (!is.null(g$vp)) g$vp else g$childrenvp  # work with either vp slot

  frame <- rectGrob(
    x = 0.5, y = 0.5,
    width  = unit(1, "npc") - 2 * pad,
    height = unit(1, "npc") - 2 * pad,
    gp = gpar(fill = NA, col = col, lwd = lwd),
    vp = vp
  )

  if (draw_under) grobTree(frame, g) else grobTree(g, frame)
}
```

```{r fig-rent-35younger-venn-blank}
#| label: fig-rent-35younger-venn-blank
#| out-width: 70%
#| fig-cap: | 
#|     Venn diagram showing the relationship between A = {age 35 or younger} and R = {rent}, without probabilities.
#| fig-alt: |
#|   A Venn diagram consisting of a blue circle and a red circle with an overlapping area. The red circle represents event A and the blue circle represents event R. There are no labels with probabilities.
library(VennDiagram)
# Draw Venn diagram with specified areas
age_venn <-  draw.pairwise.venn(
  area1 = 0.489,     # set A
  area2 = 0.30,      # set B
  cross.area = 0.195, # overlap
  category = c("<= 35", "Rents"),
  fill = c(IMSCOL["blue", "full"], IMSCOL["red", "full"]),
  lty = "blank",
  #cex = 1.5,
  cat.cex = 1.5,
  ext.text = TRUE,
  scaled = FALSE,
  cex = 0
)

grid.draw(add_vd_border(age_venn, pad = unit(1.5, "mm"), lwd = 2))
```

```{r fig-female-80plus-venn-blank, include = F}
#| label: fig-female-80plus-venn-blank
#| out-width: 70%
#| fig-cap: | 
#|     Venn diagram showing the relationship between A = {age 80+} and F = {female}, without probabilities.
library(VennDiagram)
# Draw Venn diagram with specified areas
age_venn <-  draw.pairwise.venn(
  area1 = 0.505,     # set A
  area2 = 0.118,      # set B
  cross.area = 0.074, # overlap
  category = c("Female", "80+"),
  fill = c(IMSCOL["blue", "full"], IMSCOL["red", "full"]),
  lty = "blank",
  #cex = 1.5,
  cat.cex = 1.5,
  ext.text = TRUE,
  scaled = FALSE,
  cex = 0
)

grid.draw(add_vd_border(age_venn, pad = unit(1.5, "mm"), lwd = 2))
```

@fig-rent-35younger-venn adds the probabilities to the diagram. The overlapping segment is $P(A \text{ and } R)$. By the general multiplication rule:
$$
P(A \text{ and } R) = P(R \mid A)P(A) = (0.65)(0.30) = 0.195.
$$
By the rule of total probability (@eq-total-probability)
$$
  P(A) = P(A \text{ and } R) + P(A \text{ and } R^c),
$$
so
$$
P(A \text{ and } R^c) = P(A) - P(A \text{ and } R) = 0.30 - 0.195 = 0.105.
$$
Using the same logic, the blue section on the right which does not overlap represents $P(A^c \text{ and }R)$ and equals 0.294.

```{r fig-rent-35younger-venn}
#| label: fig-rent-35younger-venn
#| out-width: 70%
#| fig-cap: | 
#|     Venn diagram showing the relationship between A = {age 35 or younger} and R = {rent}, with probabilities.
#| fig-alt: |
#|     A Venn diagram consisting of a blue circle and a red circle with an overlapping area. The red circle represents event A and the blue circle represents event R. The overlapping part is labeled 0.195. The non-overlapping red area is labeled 0.294 and the non-overlapping blue area is labeled 0.105.
library(VennDiagram)
# Draw Venn diagram with specified areas
age_venn <-  draw.pairwise.venn(
  area1 = 0.489,     # set A
  area2 = 0.30,      # set B
  cross.area = 0.195, # overlap
  category = c("<= 35", "Rents"),
  fill = c(IMSCOL["blue", "full"], IMSCOL["red", "full"]),
  lty = "blank",
  #cex = 1.5,
  cat.cex = 1.5,
  ext.text = TRUE,
  scaled = FALSE,
  cex = 1.5
)

grid.draw(add_vd_border(age_venn, pad = unit(1.5, "mm"), lwd = 2))
```

```{r fig-female-80plus-venn, include = F}
#| label: fig-female-80plus-venn
#| out-width: 70%
#| fig-cap: | 
#|     Venn diagram showing the relationship between A = {age 80+} and F = {female}, with probabilities.
library(VennDiagram)
# Draw Venn diagram with specified areas
age_venn <-  draw.pairwise.venn(
  area1 = 0.505,     # set A
  area2 = 0.118,      # set B
  cross.area = 0.074, # overlap
  category = c("Female", "80+"),
  fill = c(IMSCOL["blue", "full"], IMSCOL["red", "full"]),
  lty = "blank",
  #cex = 1.5,
  cat.cex = 1.5,
  ext.text = TRUE,
  scaled = FALSE,
  cex = 1.5
)

grid.draw(add_vd_border(age_venn, pad = unit(1.5, "mm"), lwd = 2))
```

(b) The conditional probability $P(A \mid R)$ is 
\begin{align*}
P(A \mid R) &= \frac{P(A \text{ and } R)}{P(R)} \\
            &= \frac{0.195}{0.294 + 0.195} \\
            &= 0.399.
\end{align*}


(c) Out of people who are age 35 or younger, 65\% rent their home. The quantity in part b., however, indicates that out of people who rent their home, 39.9\% are age 35 or younger.

:::

::: {.guidedpractice data-latex=""}

In the above example what population is represented by the white space outside the ovals in @fig-rent-35younger-venn?  What is the probability of selecting someone 
from that population?[^probability-330]

:::

[^probability-330]: The population represented by the white space are neither renting their home nor ages 35 or younger.  They are residents who are older than 35 who own their home.  The probability in that region is 1 minus the total area in the ovals, 1 - (0.294 + 0.195 + 0.105) = 0.406.  Approximately 40.6% of the US population are older than 35 years and own their home.


```{r}
terms_chp_3 <- c(terms_chp_3, c("formula for conditional probability")
)               
```

### Independence {#sec-independent-events}

The conditional probability $P(B \mid A)$ quantifies how knowing that $A$ has occurred changes the chance of $B$ happening.  When $P(B)$ and $P(B \mid A)$ are the same, knowing that $A$ has occurred provides no information about the chance of $B$.  In that case, $A$ and $B$ are considered **independent** \index{independent} events.


::: {.important data-latex=""}
**Independent events.**

Two events $A$ and $B$ in a  sample space are independent when 
$$
  P(B \mid A) = P(B).
$${#eq-independence-definition}
::: 

Applying the multiplication rule to solve for $P(A \text{ and } B)$ when $A$ and $B$ are independent yields an alternative formula for $P(A \text{ and } B)$ that is specific to independent events:

$$
 P(A \text{ and } B) = P(A)P(B \mid A) = P(A)P(B).
$${#eq-two-independent-events}

Similarly, if there are $k$ events $A_1$, ..., $A_k$ from $k$ independent processes, then the probability they all occur is
$$
P(A_1) P(A_2) \cdots P(A_k).
$${#eq-k-independent-events}

Independence for two events can be checked using either  @eq-independence-definition or @eq-two-independent-events. 

::: {.workedexample}

In the US population, 45% of people are blood group O. Suppose that 40% of Asian people living in the US are blood group O, and that the Asian population in the United States is approximately 4%. Do these data suggest that blood group is independent of ethnicity?

---------------------------------------

Let $B$ represent blood group O, and $A$ represent Asian ethnicity. Since $P(B|A) = 0.40$ does not equal $P(B) = 0.45$, the two events are not independent.   

Alternatively, check whether $P(A \text{ and } B)$ equals $P(A)P(B)$. $P(A)P(B) = (0.04)(0.45) = 0.018$ and since $P(A)P(B) \neq P(A \text{ and } B)$, blood group is not independent of ethnicity.

:::

::: {.guidedpractice data-latex=""}

**Independent versus disjoint events.**  Suppose you pick a day at random from the annual calendar of 365 days, and let $A$ = {the day chosen is in October} and $B$ = {the day chosen is in summer}.  Are $A$ and $B$ independent?  Are they disjoint? 
[^probability-301]

:::

[^probability-301]: $A$ and $B$ are not independent since $P(B)$ = 1/12 (approximately) but $P(B|A) = 0$, since a day in October cannot be a day in summer. The two events are disjoint, however, since both $A$ and $B$ cannot happen simultaneously. Another way to approach this question is to apply the reasoning that since $A$ and $B$ are disjoint, they are necessarily dependent; if $A$ happens, then $B$ does not happen. 

::: {.guidedpractice data-latex=""}

Is the event of drawing a heart from a deck of cards independent of drawing an ace? [^probability-302]

:::

[^probability-302]:The probability the card is a heart is 13/52 = 1/4  and the probability that it is an ace is 4/52=1/13. The probability that the card is the ace of hearts $\text{A}{\heartsuit}$) is 1/52. Check whether @eq-two-independent-events is satisfied: $$P(\text{A})P({\heartsuit}) =\left( \frac{1}{13} \right)\left(\frac{1}{4} \right) = \frac{1}{52} 
= P({\text{A}\color{redcards}\heartsuit}).$$  Since the equation holds, the event that the card is a heart and the event that the card is an ace are independent events.



::: {.workedexample data-latex=""}

Mandatory drug testing in the workplace is common practice for certain professions, such as air traffic controllers and transportation workers.  A false positive in a drug screening test occurs when the test incorrectly indicates that a screened person is an illegal drug user. Suppose a mandatory drug test has a false positive rate of 1.2% (i.e., has probability  0.012 of indicating that an employee is using illegal drugs when that is not the case).  Given 150 employees who are in reality drug free, what is the probability that at least one will falsely test positive? Assume that the outcome of one drug test provides no information about the others.

------------------------------------------------------------------------

First, note that the complement of at least 1 person testing positive is that no one tests positive (i.e., all employees test negative). The multiplication rule can then be used to calculate the \begin{align*}
P(\text{At least 1 } \texttt{+}) 
  &= P(\text{1 or 2 or 3 } \cdots \text{ or 150 are } \texttt{+}) \\
  &= 1 - P(\text{None are } \texttt{+}) \\
  &= 1 - P(\text{150 are } \texttt{-}) \\
  &= 1 - P(\texttt{-})^{150} \\
  &= 1 - (0.988)^{150} \\
  &= 1 - 0.16 \\
  &= 0.84.
\end{align*}
 Even when using a test with a small probability of a false positive, the company is more than 80\% likely to incorrectly claim at least one employee is an illegal drug user!

:::

::: {.guidedpractice data-latex=""}

Because of the high likelihood of at least one false positive in company-wide drug screening programs, an individual who tests positive is always re-tested with a different screening test: one that is more expensive but has a lower false positive probability. Suppose the second test has a false positive rate of 0.8%.  

a) Suppose that once we know an employees true drug-use status, knowing the result of one test gives us no additional information about how the employee will perform on the other test. Under that assumption, what is the probability that a drug-free employee tests positive on both tests?

b) In reality, the two tests might not be completely unrelated, even for employees who don't use drugs. Posit an explanation as to why it might not be realistic to assume that the outcome of the two tests are unrelated for an employee who does not use drugs.

c) Now consider the situation in which the drug use behavior of the employee is unknown. How does this differ from part (a), which conditioned on the person not using drugs? Would you expect the two test results to be independent? Explain your reasoning.[^probability-303]

:::

[^probability-303]: (a) Under the assumption that once we know a person's true drug use status, the two tests are independent; thus, $P (A\text{ and } B) = P(A) P(B)$, where events $A$ and $B$ are the results of the two tests. The probability of a false positive with the first test is 0.012 and 0.008 with the second. Thus, the probability of an employee who is not using illegal drugs testing positive on both tests is $(0.012) (0.008) = (9.6) 10^{-5}.$ (b) A person who falsely tests positive on the first test may be more likely to test positive on a second test due to factors such as certain medications or dietary factors. In that case, the outcomes of the two tests would not be independent. (c) In a situation where the employee's drug use status is unknown (i.e., drug use status is no longer being conditioned on), then it would be reasonable to think that the two test results are dependent. Seeing a positive result on the first test makes it more likely that the person actually uses drugs, which increases the chance of a positive result on the second test. *Note*: This scenario illustrates the idea of **conditional independence**. The two tests may be independent within each group (drug users and non-users) but not independent in the overall population. In other words, the tests are independent given the employee's true drug status, but dependent when that status is unknown.


::: {.workedexample data-latex=""}

**ABO blood groups** There are four different common blood types (A, B, AB, and O) that are determined by the presence of certain antigens located on cell surfaces. Antigens are substances used by the immune system to recognize self versus non-self; cells with antigens not normally found own the body's own cells will be recognized as foreign. When patients receive blood transfusions, it is critical that the antigens of transfused cells match those of the patient's, or else an immune system response will be triggered.

The ABO blood group system consists of four different blood groups, which describe whether an individual's red blood cells carry the A antigen, B antigen, both, or neither. The ABO gene has three alleles: ${I}^{A}$, ${I}^{B}$, and *i*. The *i* allele is recessive to both ${I}^{A}$ and ${I}^{B}$, and does not produce antigens; thus, an individual with genotype ${I}^{A}i$ is blood group A and an individual with genotype ${I}^{B}i$ is blood group B. The ${I}^{A}$ and ${I}^{B}$ alleles are codominant, such that individuals of ${I}^{A}$${I}^{B}$ genotype are AB. Individuals who inherit two copies of the $i$ allele are known as blood group O, with neither A nor B antigens. @fig-abo-inheritance shows graphically how inheritance determines blood group.

```{r abo-inheritance}
#| label: fig-abo-inheritance
#| out-width: 70%
#| fig-cap: |
#|   Pattern of inheritance for the alleles that determine one of the four different common blood groups (A, B, AB, and O)
#| fig-alt: |
#|   A diagram showing possible offspring blood groups based on combinations of alleles $I^A$, $I^B$, and $i$, arranged in the form of a table. The top row and left column list the possible parental alleles. Each cell inside the table shows the resulting offspring genotype from combining one allele from each parent. The genotypes $I^A I^A$ and $I^A i$ correspond to blood group A; $I^B I^B$ and $I^B i$ to blood group B; $I^A I^B$ to blood group AB; and $ii$ to blood group O.
#| fig-pos: H
knitr::include_graphics("images/abo-inheritance.png")
```

Suppose that both members of a couple have Group AB blood.	(a) What is the probability that a child of this couple will have Group A blood? (b) What is the probability that they have two children with Group A blood? (c) Parts (a) and (b) assumed that the parental genotypes were known. Now, suppose that both parents are known to have Group A blood, but it is unknown whether they are $I^A I^A$ or $I^A i$. Would the blood groups of their children still be independent? Think about whether seeing the blood group of one child would provide any information about the likely blood groups of their siblings.

------------------------------------------------------------------------

(a) An individual with Group AB blood is genotype ${I}^{A}$${I}^{B}$. Two ${I}^{A}$${I}^{B}$ parents can produce children with genotypes ${I}^{A}$${I}^{B}$, ${I}^{A}$${I}^{A}$, or ${I}^{B}$${I}^{B}$. Of these possibilities, only children with genotype ${I}^{A}$${I}^{A}$ have Group A blood. Each parent has 0.5 probability of passing down their ${I}^{A}$ allele. Thus, the probability that a child of this couple will have Group A blood is P(parent 1 passes down ${I}^{A}$ allele) $\times$ P(parent 2 passes down ${I}^{A}$ allele) = $(0.5)(0.5) = 0.25$.

  (b) Inheritance of alleles is independent between children. Thus, the probability of two children having Group A blood equals P(child 1 has Group A blood) $\times$ P(child 2 has group A blood). The probability of a child of this couple having Group A blood was previously calculated as 0.25, so the answer is $(0.25)(0.25) = 0.0625$.
  
  (c) If the parental genotypes are known, the children's blood groups are independent given those genotypes because the process of inheriting alleles for each child is separate. But, if the parental genotypes are unknown, then observing one child's blood group provides information about what alleles the parents likely carry, which provides new information that affects the predicted probability for the next child's blood group. For example, if a couple with Group A blood has five children who are all blood group A, that pattern makes it more likely that the parents are $I^A I^A$ genotype rather than (both) $I^A i$. If each parent were $I^A i$, about one in four children would be expected to have blood group O. Not seeing any Group O children suggests that the parents probably do not carry the $i$ allele and that the next child will also be Group A. 
	
:::

```{r}
terms_chp_3 <- c(terms_chp_3, c("multiplication rule",
                                "independent events")
)
```



## Statistical properties of diagnostic tests {#sec-diagnostic-tests}

### The terminology of diagnostic tests {#sec-terminology-diag-tests}

@sec-two-examples opened this chapter with a question about the likelihood of a COVID-19 Rapid Antigen Test (RAT) correctly predicting the presence of the virus.  Let {COVID-19} denote the event that someone has the virus and {RAT^+^} denote a positive self-test. Suppose, as in @sec-two-examples, the probability of a positive test in a person with the virus is 0.80 (80%). In the language of conditional probability, 
$$
P(\text{RAT}^+ \mid \text{COVID-19}) = 0.80.
$${#eq-rat-sensitivity}

The likelihood of a positive test correctly predicting the presence of the virus is the reverse conditional probability:
$$
P(\text{COVID-19} \mid \text{RAT}^+).
$${#eq-rat-ppv}

From earlier examples, it is clear that it would be wrong to assume these two conditional probabilities are equal.

The solution to this problem is an important application of probability to diagnostic medicine.  In clinical care settings, diagnostic tests that return positive or negative values (disease present or absent) are frequently used to screen for  underlying conditions. ^[@Mukherjee2025EarlyDetection provides an interesting and readable account of current issues in screening for cancer.]

Specific terminology is used to describe behavior of diagnostic tests.  Suppose $D$ denotes the presence of a disease and $D^C$ its absence.  Let $T^+$ and $T^-$ denote the events of a positive and negative diagnostic test, respectively.

* The **prevalence** of a disease $D$ is the proportion of individuals in a population with the disease.  It is the probability that a randomly chosen member of a population has the disease and is denoted by $P(D)$.

* The **sensitivity** \index{sensitivity} of a test is the conditional probability $P(T^+ \mid D)$.  If someone has the disease, how often is the test positive?  Sensitivity is also called the probability of a true positive result.

* The **specificity** \index{specificity} of a test is the conditional probability $P(T-\mid D^C)$. If someone does not have the disease, how often is the test negative?  Specificity is the probability of a true negative result.

* The **positive predictive value (PPV)** \index{positive predictive value} of a test is the conditional probability $P(D \mid T^+)$. If someone tests positive, how often do they have the disease?

* The **negative predictive value (NPV)** \index{negative predictive value} of a test is the conditional probability $P(D^C \mid T^-)$.  If someone tests negative, how often do they not have the disease?

@eq-rat-sensitivity posits a sensitivity for a RAT, while @eq-rat-ppv represents the positive predictive value of a RAT. 
How are the PPV of a test and the sensitivity of a test related? The PPV of a test actually depends on the test's sensitivity and specificity, as well as the prevalence of disease. 

This section discusses three approaches to calculating the PPV of a test: 1) tree diagrams, 2) applying Bayes' Rule, and 3) constructing a $2 \times 2$ table based on a hypothetical population. 

Note that the prevalence of COVID-19 changes seasonally and varies by region. Initially, the solution discussed in the subsequent sections assumes the infection is present in 5\% of the population, so $P(D) = 0.05$. Later, the relationship between PPV and prevalence is also explored.

### Tree diagrams {#sec-tree-diagrams}

A **tree diagram** \index{tree diagram} is a useful visual tool for organizing probabilities when two or more related events occur, and the probability of one event depends on the outcome of another. The tree makes conditional probabilities explicit and provides a systematic way to compute joint probabilities.

```{r}
# ppv for covid RAT
# also used and repeated later
# 

sens_rat <- 0.80
spec_rat <- 0.98
prev_covid <- 0.05
```

In @fig-rat-tree, the primary branches divide the population by COVID-19 status: an individual either has COVID-19 or does not, with marginal probabilities 0.05 and 0.95. 

The secondary branches show the possible outcomes of a RAT, conditional on an individual's disease status. Although there are two branches labeled positive, they represent different conditional events. One branch corresponds to testing positive given that COVID-19 is present, while the other corresponds to testing positive given that COVID-19 is absent. For example, among individuals who have COVID-19, the probability of a positive test is 0.80, and the probability of a negative test is 1 - 0.80 = 0.20. Similarly, among individuals who do not have COVID-19, the probabilities of a positive and negative test are 0.02 and 0.98, respectively. 

At each of these secondary branch points, the probabilities add to 1 because they describe all possible test outcomes conditional on a particular disease status. More generally, at any branch point in a tree diagram, the outgoing branches must sum to 1 because they represent all possible outcomes given the events that have already occurred. 

```{r rat-tree}
#| label: fig-rat-tree
#| out-width: 80%
#| fig-cap: | 
#|     Tree diagram for the behavior of COVID-19 self-tests (RATs)
#| fig-alt: | 
#|  Tree diagram drawn as branching line segments arranged from left to right. A single starting point on the left splits into two branches representing COVID-19 status: COVID-19 present with probability 0.05 and COVID-19 absent with probability 0.95. Each of these branches then splits again into two branches representing rapid antigen test outcomes, creating four endpoints in total. From the COVID-19 present branch, the test result splits into positive with conditional probability 0.80 and negative with conditional probability 0.20. From the COVID-19 absent branch, the test result splits into positive with conditional probability 0.02 and negative with conditional probability 0.98. Following any complete path from left to right corresponds to one joint outcome combining disease status and test result.


treeDiag(c('COVID-19', 'RAT Self test'),
         c(0.05, 0.95),
         list(c(0.80, 0.20),
              c(0.02, 0.98)),
         textwd = 0.2,
         solwd = 0.35,
         cex.main = 1.4,
         c('present', 'absent'),
         c('positive','negative'),
         digits = 5,
         col.main = COL[1],
         showWork = TRUE)
```

Each complete path through the tree corresponds to a unique joint outcome, such as having COVID-19 and testing positive. Since these joint outcomes show all possible combinations of what could happen, the probabilities at the ends of the branches must sum to 1.

Joint probabilities are calculated at the end of each branch by multiplying the numbers from right to left, using the multiplication rule, @eq-mult-rule-two-probs. For instance, the probability of having the infection and testing positive is the conditional probability of testing positive given COVID-19 is present times the probability COVID-19 is present:

\begin{align*}
P(\text{COVID-19 and RAT$^+$}) &= P(\text{RAT$^+$ } |\ \text{COVID-19}) \times  P(\text{COVID-19}) \\
	&= (0.80) (0.05) \\ 
	&= 0.04.
\end{align*}

The rest of the joint probabilities are calculated the same way.

The tree diagram can be used to calculate the PPV of a RAT:
\begin{align*}
P(\text{COVID-19} \mid \text{RAT}^+) =& \frac{P(\text{COVID-19 and RAT}^+)}
{P(\text{RAT}^+)} \\
=& \frac{P(\text{COVID-19 and RAT}^+)}
{P(\text{COVID-19 and RAT}^+) + P(\text{COVID-19}^C  \text{and RAT}^+)}
\end{align*}

The numerator is the probability of the top branch, 0.04.  The denominator is the sum of the probabilities along the two branches that lead to a positive RAT: either a true positive when having COVID-19, 0.04, or a false positive in the absence of the infection, 0.019. Thus, $P(\text{RAT}+)$ = 0.059. The PPV is the ratio 0.04/0.059 = 0.678.  With a positive self-test, the chance of COVID-19 is 68% under the assumption that the prevalence of the infection is 5%.


```{r}
# ppv for covid RAT
# also used and repeated later
# 

sens_rat <- 0.80
spec_rat <- 0.98
prev_covid_03 <- 0.03


ppv_rat_03 <- round((sens_rat * prev_covid_03)/(sens_rat * prev_covid_03 + (1 - spec_rat) * (1 - prev_covid_03)), 2)
npv_rat_03 <- round(spec_rat * (1 - prev_covid_03) /(spec_rat * 1 - prev_covid_03 + (1 - sens_rat) * prev_covid_03), 2)

prev_covid_08 <- 0.08
ppv_rat_08 <- round((sens_rat * prev_covid_08)/(sens_rat * prev_covid_08 + (1 - spec_rat) * (1 - prev_covid_08)), 2)
npv_rat_08 <- round(spec_rat * (1 - prev_covid_08) /(spec_rat * 1 - prev_covid_08 + (1 - sens_rat) * prev_covid_08), 2)
```


::: {.workedexample data-latex=""}

Assuming the same diagnostic test characteristics and prevalence of COVID-19, use the tree diagram to calculate the negative predictive value (NPV) of a COVID-19 self-test.

------------------------------------------------------------------------

The NPV is 
$$
P(\text{COVID-19}^C \mid \text{RAT}^-) = \frac{P(\text{COVID-19}^C \text{ and RAT}^-)}
{P(\text{RAT}^-)}.
$$  
The numerator is the value at the end of the lowest branch, 0.931.  The denominator is sum of the values on the two branches that lead to a negative test, 0.01 + 0.931 = 0.941.  The NPV is 0.931/0.941 = 0.989.  Under the assumptions used here, the chance that the infection is absent when a test is negative is 99%. 
:::

Even after using a tree diagram to calculate the PPV, the result may still seem counterintuitive. The test has high sensitivity and specificity, so why is the PPV is only about 68%? A mosaic plot helps clarify this by showing how the population is distributed across test result and disease status. In @fig-mosaic, each region represents a group of individuals, with area proportional to the number of people in that group. Most of the plot is taken up by individuals who do not have COVID-19 and correctly test negative, reflecting both the low prevalence of the disease and the accuracy of the test.

Focusing on the vertical segment representing positive test results (i.e., the segment on the right), we see that although a large portion corresponds to individuals who truly have COVID-19, there remains a noticeable portion corresponding to individuals who do not have the disease. This visual contrast highlights what PPV represents: among all individuals who receive a positive test result, the PPV is the fraction who actually have the disease. The mosaic plot makes it clear that when a disease is rare, even a reasonably accurate test can produce many false positives relative to true positives. When false positives make up a substantial fraction of all positive test results, the PPV is low. 

```{r rat-mosaic}
#| label: fig-mosaic
#| out-width: 80%
#| fig-cap: | 
#|     Mosaic diagram for the behavior of COVID-19 self-tests (RATs) when prevalence is 0.05. The area of each region is proportional to the number of individuals in that category.
#| fig-alt: | 
#|  Mosaic plot showing the relationship between rapid antigen test results and COVID-19 disease status, with the plot split first by test result. The plot consists of two vertical sections labeled Test Neg. and Test Pos. The width of each section is proportional to the total number of individuals with that test result. Within each section, the area is divided by disease status, showing the proportion of individuals with COVID-19 present versus COVID-19 absent. In the Test Pos. section, a substantial portion of the area corresponds to individuals with COVID-19, indicating that a positive test is associated with a higher probability of disease compared to the overall population. In the Test Neg. section, nearly all of the area corresponds to individuals without COVID-19, reflecting a high negative predictive value. The area of each region is proportional to the number of individuals in that category.

library(ggmosaic)

total <- 10000
prev <- 0.05
sens <- 0.80
spec <- 0.98

d   <- round(prev * total)
d_c <- total - d

true_pos  <- round(sens * d)
false_neg <- d - true_pos

true_neg  <- round(spec * d_c)
false_pos <- d_c - true_neg

counts <- data.frame(
  disease = c("COVID Present", "COVID Present",
              "COVID Absent",  "COVID Absent"),
  test_result = c("Test Pos.", "Test Neg.",
                  "Test Pos.", "Test Neg."),
  n = c(true_pos, false_neg, false_pos, true_neg)
)

ggplot(counts) + 
  geom_mosaic(
    aes(x = product(test_result), weight = n,
      fill = disease)) +
  scale_fill_manual(values = c("#247ba0", "#ff1654")) +
  labs(x = "", y = "", fill = "Disease") +
  theme_light() +
  theme(text = element_text(size = 15),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

A mosaic plot also helps us reason about how the PPV (as well as the NPV) would change if the disease were more or less common in the population. If the disease were more common, a larger portion of the population would have COVID-19, and this would change the composition of both the positive and negative test groups. In @fig-mosaic-prev-high, this appears as a larger share of the Test Pos. region corresponding to individuals with COVID-19, increasing the PPV. At the same time, the Test Neg. region contains a larger share of individuals with disease, reducing the NPV. The mosaic plot makes these changes visible by showing how the mix of individuals within each test result depends on disease prevalence. When a disease is common, then true positives make up a greater portion of all positive tests, which raises the PPV.

```{r rat-mosaic-prev-high}
#| label: fig-mosaic-prev-high
#| out-width: 80%
#| fig-cap: | 
#|     Mosaic diagram for the behavior of COVID-19 self-tests (RATs) when prevalence is 0.08. The area of each region is proportional to the number of individuals in that category.
#| fig-alt: |
#|     Mosaic plot showing the relationship between rapid antigen test results and COVID-19 disease status, with the plot split first by test result. In this version of the plot, there is a greater share of the "Test Pos." section that corresponds to individuals with the disease.

library(ggmosaic)

total <- 10000
prev <- 0.08
sens <- 0.80
spec <- 0.98

d   <- round(prev * total)
d_c <- total - d

true_pos  <- round(sens * d)
false_neg <- d - true_pos

true_neg  <- round(spec * d_c)
false_pos <- d_c - true_neg

counts <- data.frame(
  disease = c("COVID Present", "COVID Present",
              "COVID Absent",  "COVID Absent"),
  test_result = c("Test Pos.", "Test Neg.",
                  "Test Pos.", "Test Neg."),
  n = c(true_pos, false_neg, false_pos, true_neg)
)

ggplot(counts) + 
  geom_mosaic(
    aes(x = product(test_result), weight = n,
      fill = disease)) +
  scale_fill_manual(values = c("#247ba0", "#ff1654")) +
  labs(x = "", y = "", fill = "Disease") +
  theme_light() +
  theme(text = element_text(size = 15),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```


The sensitivity and specificity are characteristics of the test itself and do not change unless the technology of the test changes. However, the prevalence depends on the population using the test and may change with time or location.

::: {.workedexample data-latex=""}

(a)  What is the PPV of RAT if all of the characteristics of the test remain the same but the prevalence of COVID-19 is 0.03 instead of 0.05? 
(b)  What is the PPV if the prevalence is 0.08 instead of 0.05?

------------------------------------------------------------------------

a. If the prevalence decreases from 0.05 to 0.03, the probability of the top branch will be (0.03)(0.80) = 0.24. The probability of a positive RAT will be (0.03)(0.80) + (0.97)(0.98) = 0.975.  The PPV will be 0.24/0.975 = 0.246.  The chance of COVID-19 is only 25% when a self-test is positive but the prevalence of the infection is 3%.

b. When the prevalence is 0.08 (8%), the 
\begin{align*} 
\text{PPV}  &= \frac{(0.08)(0.80)} {(0.08)(0.80) + (0.92)(0.02)} \\
&= 0.777
\end{align*}
The chance of COVID-19 after a positive test increases to 78% when the prevalence of the infection is 8% instead of 5%.

The chance you have COVID-19 after a positive test depends on how many people around you are infected as well as the quality of the test. 
:::

The dependence of PPV on prevalence creates a challenge when screening populations for rare diseases: even when a test is accurate, a substantial proportion of positive test results may be false positives. This is especially important when a positive screening result is followed by a more invasive or costly diagnostic procedure. 

These considerations help explain why screening recommendations for entire populations often weigh the benefits of early detection against the risks associated with false positive results. For example, prostate-specific antigen (PSA) testing is used to screen for prostate cancer, a disease that is relatively uncommon in the general population. Widespread screening may identify many individuals who do not have cancer but are referred for additional procedures such as prostate biopsy. For this reason, PSA screening is typically recommended only for specific age groups in which prostate cancer is more common, since higher disease prevalence increases the PPV and reduces the proportion of false positive results.


### Bayes' Rule  {#sec-bayes-rule}

Bayes' Rule provides a formula for calculating conditional probabilities when the event of interest and conditioning event are reversed, as in sensitivity and PPV. 

::: {.important data-latex=""}
**Bayes' Rule, short version**[^probability-341]

[^probability-341]: @eq-bayes-rule is a direct application of the definition of conditional probability and the multiplication rule.
$$
 P(B \mid A) = \frac{P(A \text{ and } B)}{P(A)} = \frac{P(A \mid B)P(B)}{P(A)}.
$$


Suppose $A$ and $B$ are two events in a sample space.  Then

$$
P(B \mid A) = \frac{P(A \mid B) P(B)}{P(A)}. 
$${#eq-bayes-rule}


::::

Bayes' Rule applied to a diagnostic test shows how PPV depends on the characteristics of a test and the prevalence of the disease.
If $A = T^+$ and $B = D$, @eq-bayes-rule becomes 
$$
P(D \mid T^+) = \frac{P(T^+ \mid D) P(D)}{P(T^+)}. 
$${#eq-bayes-testing}

@eq-bayes-testing shows that the PPV of a test depends on its sensitivity $P(T^+ \mid D)$, the prevalence $P(D)$, and the probability of a positive test in the population $P(T^+)$.  The chance of a positive test is rarely specified in advance, but can be calculated using the characteristics of the test and the prevalence of disease:
\begin{align*}
P(T^+) &= P(T^+ \text{ and } D) + P(T^+ \text{ and } D^C) \\
       &= P(T^+ \mid D)P(D) + P(T^+ \mid D^C)P(D^C) \\
\end{align*}
The first line uses the Law of Total Probability (@eq-total-probability) and the second the Multiplication Rule (@eq-mult-rule-two-probs).

Using this expression for the denominator in @eq-bayes-testing,  
$$
\text{PPV} = \frac{P(T^+ \mid D) P(D)}{P(T^+ \mid D)P(D) + P(T^+ \mid D^C)P(D^C)}.
$${#eq-bayes-testing-expanded}

@eq-bayes-testing-expanded leads to a useful mnemonic often used in medicine and public health for the PPV of a diagnostic test:

$$
\text{PPV} = \frac{\text{sensitivity } \times \text{ prevalence}}{[\text{sensitivity } \times \text{ prevalence}] + [\text{(1 - specificity) } \times \text{ (1 - prevalence)}]}.
$${#eq-bayes-ppv-mnemonic}

The negative predictive value (NPV) of a diagnostic test is the conditional probability $P(D^C \mid T^-)$.  Bayes' Rule can be used to show
$$
\text{NPV} = \frac{\text{specificity } \times (\text{1 - prevalence})}{[(\text{1 - sensitivity}) \times \text{ prevalence}] + [\text{specificity } \times \text{ (1 - prevalence)}]}.
$${#eq-bayes-npv-mnemonic}


::: {.guidedpractice data-latex=""}

Some congenital disorders are caused by errors that occur during cell division, resulting in the presence of additional chromosome copies. Trisomy 21 (Down syndrome) occurs in approximately 1 out of 800 live births in the United States. Cell-free fetal DNA (cfDNA) testing is one commonly used way to screen fetuses for trisomy 21. The test sensitivity is 0.98 and the specificity is 0.995. Calculate the PPV and NPV of the test for this population. [^probability-440]
:::

[^probability-440]:
\begin{align*}
\text{PPV} &= \frac{\text{sensitivity } \times \text{ prevalence}}{[\text{sensitivity } \times \text{prevalence}] + [\text{(1 - specificity) } \times \text{ (1 - prevalence)}]} \\
&= \frac{(0.98)(1/800)}{(0.98)(1/800) + (1 - 0.995)(799/800)} \\
&= 0.197
\end{align*}
\begin{align*}
\text{NPV} &= \frac{\text{specificity } \times (\text{1 - prevalence})}{[\text{(1 - sensitivity)} \times \text{prevalence}] + [\text{specificity} \times \text{(1 - prevalence})]} \\
&= \frac{(0.995)(799/800)}{(1-0.98)(1/800) + (0.995)(799/800)} \\
&= 0.999975
\end{align*}
The test has low positive predictive value but high negative predictive value.

::: {.guidedpractice data-latex=""}

If your were counseling parents whose fetus will be tested for Trisomy 21 using cfDNA, what would you tell them in advance about interpreting the outcome of the test, without using any of the jargon from probability?
[^probability-441]
:::

[^probability-441]: Here is one possible script: Since you have no special risk factors for Down syndrome in an infant,  your overall chance of having an affected infant is about 1/800, approximately one tenth of 1%. The test we use to screen for the congenital mutation is the best we have, but it is not perfect. If the test is negative (suggesting the mutation is not present) there is a 99.5% chance that your infant will not be affected. If it is positive, then there is about a 20% chance the mutation is present. In other words, a positive result does not indicate with 100% certainty that your infant will be affected. But rather, it would indicate that there is about a 1 in 5 chance of Down syndrome. Do you have any questions?

@eq-bayes-testing-expanded is a specific example of more general versions of Bayes' rule:

::: {.important data-latex=""}
**Bayes' rule, full version.**

Suppose $A$ and $B$ are events in a sample space.  Then
$$
  P(B \mid A) = \frac{P(A \mid B) P(B)}{P(A \mid B) P(B) + P(A \mid B^C) P(B^C)}.
$${#eq-bayes-trad}
More generally suppose that $B = (B_1 \text{ and } B_2  \cdots \text{ and } B_k)$, where the events $B_1, B_2, \cdots, B_k$ are disjoint.  Then 

$$
P(B \mid A) = \frac{P(A | B_1) P(B_1)}
	{P(A | B_1) P(B_1) + P(A | B_2) P(B_2) + \cdots + P(A | B_k) P(B_k)}.
$$ {#eq-bayes-trad-gen}

:::

The most general form of Bayes' rule will be used in @sec-cat-genetics, an extended example of using conditional probability in a genetics problem.

### Contingency tables {#sec-contingency-tables-diag-tests}

```{r}
# code for contingency tables

prev_ct_05 <- 0.05
sens_ct <- 0.80
spec_ct <- 0.98
N_ct <- 100000

covid_cases_05 <- prev_ct_05 * N_ct 
covid_absent_05 <- N_ct - covid_cases_05
t_pos_05 <- covid_cases_05 * sens_ct
f_neg_05 <- covid_cases_05 * (1 - sens_ct)
t_neg_05 <- covid_absent_05 * spec_ct
f_pos_05 <- covid_absent_05 * (1 - spec_ct)
tot_pos_05 <-  t_pos_05 + f_pos_05
tot_neg_05 <- t_neg_05 + f_neg_05

ppv_05 <- round(t_pos_05 / tot_pos_05, 3)


```

Contingency tables provide another way to calculate the positive predictive value (PPV) that may feel more concrete than tree diagrams or Bayes' Rule. Rather than working directly with probabilities, this approach begins by imagining a large, hypothetical population and calculating how many individuals fall into each combination of test result and disease status. When the hypothetical population is large, the resulting proportions closely approximate the exact probabilities obtained using the earlier approaches. 

The method begins by constructing an empty $2 \times 2$ table, with the possible outcomes of the diagnostic test as the rows and the possible disease statuses as the columns as in @tbl-rat-setup. Each cell of the table represents a group of individuals. The table should include cells for the row and column sums.


|               | COVID-19 Present | COVID-19 Absent  | Sum     |
|---------------|------------------|------------------|---------|
| RAT Positive | --                | --               | --      |
| RAT Negative | --                | --               | --      |
| Sum          | --                | --               | 100,000 |

: A 2 \times 2 table for the COVID RAT test example with a hypothetical population size $N$ of 100,000 {#tbl-rat-setup} 

Like the mosaic plot, the contingency table represents the population as groups of individuals defined by test result and disease status, but does so numerically rather than visually. 

The table can be populated by thinking through how the test classifies individuals, using the earlier provided information about the test characteristics and assumed prevalence:

* An 80% chance of testing positive for individuals with COVID-19

* A 98% chance of testing negative for individuals without COVID-19

* An assumed prevalence of 5%

1.  Calculate the two column totals (the number of individuals with and without COVID-19) from $P(\text{COVID-19})$, the infection prevalence:
	$$N \times P(\text{COVID-19}) = 100,000 \times .05 = 5,000 \text{ individuals with COVID-19}.$$
	$$N \times [1 - P(\text{COVID-19})] = 100,000 \times [1 - 0.05] = 95,000 \text{ individuals without COVID-19}.$$
	
	Alternatively, the number of individuals without COVID-19 can be calculated by subtracting the number with COVID-19 from $N$.
	
2. Calculate the two numbers in the first column: the number of individuals with COVID-19 testing either positive (true positive) or negative (false negative). Recall that since 80\% of individuals with COVID-19 test positive, then $(1 - 0.80)(100) = 20$\% test negative.
	$$\text{COVID-19 infected} \times P(\text{true positive}) = 5,000 \times 0.80 = 4,000 \text{ true positives}$$
	$$\text{COVID-19 infected} \times P(\text{false negative}) = 5,000 \times 0.20 = 1,000 \text{ false negatives}$$
	
3. Calculate the two numbers in the second column: the number of individuals without the infection testing either positive (false positive) or negative (true negative). Recall that since 98\% of individuals without COVID-19 test negative, then $(1 - 0.98)(100) = 2$\% test positive.
	$$\text{COVID-19 uninfected} \times P(\text{false positive}) = 95,000 \times 0.02 = 1,900 \text{ false positives}$$
	$$\text{COVID-19 uninfected} \times P(\text{true negative})] = 95,000 \times 0.98 = 93,100 \text{ true negatives}$$
	
4.  Complete the table by calculating the two row totals: the number of positive and negative mammograms out of 100,000.
	$$(\text{true positives}) + (\text{ false positives}) = 4,000 + 1,900 = 5,900 \text{ positives}$$
	$$(\text{true negatives}) + (\text{false negatives}) = 93,100 + 1,000 = 94,100 \text{ negatives}$$
	
5.  Finally, calculate the PPV of the RAT test using the ratio of the number of true positives to the total number of positive tests. This estimate is more than accurate enough, with the estimated value matching the exact calculation up to the third decimal place. 
	
	$$\frac{\text{ true positive tests}}{\text{ positive tests}} = \frac{`r t_pos_05`}{`r tot_pos_05`} = `r ppv_05`. $$


|             | COVID-19 Present | COVID-19 Absent | Sum     |
|-------------|------------------:|---------------:|---------:|
| RAT Positive | `r t_pos_05`     | `r f_pos_05`         | `r tot_pos_05`  |
| RAT Negative | `r f_neg_05`     | `r t_neg_05`          | `r tot_neg_05`  |
| Sum          | `r covid_cases_05` | `r covid_absent_05` | `r N_ct` |

: A 2 \times 2 table for the COVID RAT test example with a hypothetical population size $N$ of 100,000 and prevalence 5%, with numbers added {#tbl-rat-complete} 

@tbl-rat-complete and the calculations used to fill in the cells provide an interpretation of PPV that focuses on individuals. The PPV of a diagnostic test is the proportion of positive test results that are true positives; i.e., the proportion of individuals who actually have the disease among all those who test positive. Viewed this way, PPV answers the question: if you are among the subset of the population who test positive, how likely is it that you truly have the disease?

<!---

```{r}
# code for contingency tables

prev_ct_01 <- 0.01
sens_ct <- 0.80
spec_ct <- 0.98
N_ct <- 100000

covid_cases_01 <- prev_ct_01 * N_ct 
covid_absent_01 <- N_ct - covid_cases_01
t_pos_01 <- covid_cases_01 * sens_ct
f_neg_01 <- covid_cases_01 * (1 - sens_ct)
t_neg_01 <- covid_absent_01 * spec_ct
f_pos_01 <- covid_absent_01 * (1 - spec_ct)
tot_pos_01 <-  t_pos_01 + f_pos_01
tot_neg_01 <- t_neg_01 + f_neg_01

ppv_01 <- round(t_pos_01 / tot_pos_01, 3)


```

@tbl-rat-complete-01 shows the behavior of a RAT if the COVID-19 prevalence is 0.01 instead of 0.05.  The values in the cells are calculated using the earlier formulas.



|             | COVID-19 Present | COVID-19 Absent | Sum     |
|-------------|------------------:|---------------:|---------:|
| RAT Positive | `r t_pos_01`     | `r f_pos_01`         | `r tot_pos_01`  |
| RAT Negative | `r f_neg_01`     | `r t_neg_01`          | `r tot_neg_01`  |
| Sum          | `r covid_cases_01` | `r covid_absent_01` | `r N_ct` |

: A 2 $\times$ 2 table for the COVID RAT test example with a hypothetical population size $N$ of 100,000 and COVID-19 prevalence 1% {#tbl-rat-complete-01} 

The PPV is now `r ppv_01`.  The reduced prevalence causes fewer true positive results, `r t_pos_01` versus `r t_pos_05`, and because of the larger number of individuals without the infection, an increased number of false positives, `r f_pos_01` versus `r f_pos_05`.  The ratio of true positives to total positives decreases.

The dependence of PPV on prevalence causes a conundrum in for screening populations for a rare disease -- there will be a large proportion of false positives.  That is especially important when a positive diagnostic test might be followed by a more invasive procedure.

--->

```{r}
terms_chp_3 <- c(terms_chp_3, c("Bayes' rule",
                                "sensitivity",
                                "specificity",
                                "positive predictive value (PPV)",
                                "negative predictive value (NPV)",
                                "tree diagram",
                                "diagnostic tests")
                )
```

## Extended example: cat genetics {#sec-cat-genetics}

So far, the principles of probability have been illustrated with relatively short examples. In a more complex setting, it can be surprisingly difficult to translate a problem scenario into the language of probability. This section demonstrates how the rules of probability can be applied to work through a relatively sophisticated conditioning problem.

### Problem statement {#sec-cat-genetics-problem}

The gene that controls white coat color in cats, $KIT$, is responsible for multiple phenotypes such as deafness and blue eye color. A dominant allele $W$ at one location in the gene has complete **penetrance** \index{penetrance} for white coat color; all cats with the $W$ allele have white coats. There is incomplete penetrance for blue eyes and deafness; not all white cats will have blue eyes and not all white cats will be deaf. However, deafness and blue eye color are strongly linked, such that white cats with blue eyes are much more likely to be deaf. The variation in penetrance for eye color and deafness may be due to other genes as well as environmental factors.

Suppose that 30% of white cats have one blue eye, while 10% of white cats have two blue eyes. About 73% of white cats with two blue eyes are deaf and 40% of white cats with one blue eye are deaf. Only 19% of white cats with other eye colors are deaf.

a. Calculate the prevalence of deafness among white cats.
	
b. Given that a white cat is deaf, what is the probability that it has two blue eyes?
	
c.  Suppose that deaf, white cats have an increased chance of being blind, but that the prevalence of blindness differs according to eye color. While deaf, white cats with two blue eyes or two non-blue eyes have probability 0.20 of developing blindness, deaf and white cats with one blue eye have probability 0.40 of developing blindness. White cats that are not deaf have probability 0.10 of developing blindness, regardless of their eye color.
	
    i. What is the prevalence of blindness among deaf, white cats?
		
    ii. What is the prevalence of blindness among white cats?
		
    iii. Given that a cat is white and blind, what is the probability that it has two blue eyes?
    
```{r}
terms_chp_3 <- c(terms_chp_3, c("penetrance")
                )
```

	
### Establishing notation {#sec-cat-genetics-notation}

Before beginning any calculations, it is essential to clearly define any notation that will be used. For this problem, there are several events of interest: deafness, number of blue eyes (either 0, 1, or 2), and blindness. 

* Let $D$ represent the event that a white cat is deaf.

* Let $B_0$ = {zero blue eyes}, $B_1$ = {one blue eye}, and $B_2$ = {two blue eyes}.

* Let $L$ represent the event that a white cat is blind.


Since all cats mentioned in the problem are white, it is not necessary to define whiteness as an event; white cats represent the sample space.

### Part a. Deafness

The prevalence of deafness among white cats is the proportion of white cats that are deaf; i.e., the probability of deafness among white cats. This is the value of $P(D)$.

::: {.workedexample data-latex=""}

Using the notation above, rewrite the following information from the problem statement:

> Suppose that 30% of white cats have one blue eye, while 10% of white cats have two blue eyes. About 73% of white cats with two blue eyes are deaf and 40\% of white cats with one blue eye are deaf. Only 19% of white cats with other eye colors are deaf.


------------------------------------------------------------------------

The first sentence provides information about the prevalence of white cats with one blue eye and white cats with two blue eyes: $P(B_1) = 0.30$ and $P(B_2) = 0.10$. The only other possible eye color combination is zero blue eyes (i.e., two non-blue eyes); i.e., since $P(B_0) + P(B_1) + P(B_2) = 1$, $P(B_0) = 1  - P(B_1) - P(B_2) = 0.60$. Sixty percent of white cats have two non-blue eyes.

Although it is straightforward to see that the second and third sentences describe deafness in relation to eye color, it can be easy to overlook that these probabilities are conditional. A close reading should focus on the language used in the statements, such as phrases like "About 73\% *of* white cats with two blue eyes are deaf". The word *of* signals that the percentage is calculated *out of* the group of white cats with two blue eyes, indicating a probability of deafness conditional on eye color. Interpreted this way, these sentences correspond to the conditional probabilities $P(D|B_2) = 0.73$, $P(D|B_1) = 0.40$, and $P(D|B_0) = 0.19$. 

:::

There are three possible ways to partition the event $D$ that a white cat is deaf: a cat could be deaf and have two blue eyes, be deaf and have one blue eye (and one non-blue eye), or be deaf and have two non-blue eyes. Thus, by the Addition Rule of Disjoint Events: 
$$
P(D) = P(D \text{ and } B_2 ) + P(D \text{ and } B_1 ) + P(D \text{ and } B_0 ).
$$

Although the joint probabilities of being deaf and having particular eye colors are not given in the problem, these can be calculated using the Multiplication Rule, @eq-mult-rule-two-probs:

\begin{align*}
P(D) =& P(D \text{ and } B_2 ) + P(D \text{ and } B_1 ) + P(D \text{ and } B_0 ) \\
=& P(D|B_2)P(B_2) + P(D|B_1)P(B_1) + P(D|B_0)P(B_0) \\
=& (0.73)(0.10) + (0.40)(0.30) + (0.19)(0.60) \\
=& 0.307.
\end{align*}

The prevalence of deafness among white cats is 0.307.

### Part b. Deafness and eye color

The probability that a white cat has two blue eyes, given that it is deaf, is $P(B_2|D)$: 

::: {.workedexample data-latex=""}

Using the definition of conditional probability, solve for $P(B_2|D)$. 

------------------------------------------------------------------------

\begin{align*}
P(B_2|D) &= \frac{P(D \text{ and } B_2)}{P(D)} \\
         &= \frac{P(D|B_2)P(B_2)}{P(D)} \\
         &= \dfrac{(0.73)(0.10)}{0.307} \\
         & = 0.238. 
\end{align*}

The probability that a white cat has two blue eyes, given that it is deaf, is 0.238.

:::

The conditional probability $P(B_2 \mid D)$ uses the general version of  Bayes' Rule @eq-bayes-trad-gen,
using the three possible partitions of the event of deafness, $D$. In this problem, it is possible to directly substitute the value $P(D)$  calculated in part a. The expanded denominator in the expression below matches the earlier calculation of $P(D)$.

\begin{align*}
P(B_2|D) &= \dfrac{P(D \text{ and } B_2)}{P(D)} \\
         &= \dfrac{P(D|B_2)P(B_2)}{P(D|B_2)P(B_2) + P(D|B_1)P(B_1) + P(D|B_0)P(B_0)}. 
\end{align*}

### Part c. Blindness, deafness and eye color

::: {.workedexample data-latex=""}

Reformulate the following from the problem statement into probability notation:

>Suppose that deaf, white cats have an increased chance of being blind, but that the prevalence of blindness differs according to eye color. While deaf, white cats with two blue eyes or two non-blue eyes have probability 0.20 of developing blindness, deaf and white cats with one blue eye have probability 0.40 of developing blindness. White cats that are not deaf have probability 0.10 of developing blindness, regardless of their eye color.

------------------------------------------------------------------------

The second sentence gives probabilities of blindness, conditional on eye color and being deaf: $P(L|B_2, D) = P(L|B_0, D) = 0.20$, and $P(L|B_1, D) = 0.40$. The third sentence gives the probability that a white cat is blind, given that it is not deaf: $P(L|D^C) = 0.10$.  

:::

Part i asks for the prevalence of blindness among deaf, white cats: $P(L|D)$. As in part a, the event of blindness given deafness can be partitioned by eye color:

$$
P(L|D) = P(L \text{ and } B_0|D) + P(L \text{ and } B_1 | D) + P(L \text{ and } B_2|D).
$${#eq-l-given-d}

::: {.workedexample data-latex=""}

Expand the @eq-l-given-d using the Multiplication Rule, @eq-mult-rule-two-probs.

------------------------------------------------------------------------

The general multiplication rule may seem difficult to apply when conditioning is present, but the principle remains the same. Think of the conditioning as a way to restrict the sample space; in this context, conditioning on deafness implies that for this part of the problem, all the cats being considered are deaf (and white). 
	
For instance, consider the first term, $P(L \text{ and } B_0|D)$, the probability of being blind and having two non-blue eyes, given deafness. How could this be rewritten if the probability were simply $P(L \text{ and } B_0)$? 
$$
P(L \text{ and } B_0) = P(L|B_0)P(B_0).
$$
Now, recall that for this part of the problem, the sample space is restricted to deaf (and white) cats. Thus, all of the terms in the expansion should include conditioning on deafness:
$$
P(L \text{ and } B_0|\textcolor{red}{D}) = P(L|\textcolor{red}{D}, B_0)P(B_0|\textcolor{red}{D}). 
$$
Thus, 
$$
P(L|D) = P(L|D, B_0)P(B_0|D) + P(L|D, B_1)P(B_1|D) + P(L|D, B_2)P(B_2|D).
$$

:::

Although $P(L|D, B_0)$, $P(L|D, B_1)$, and $P(L|D, B_2)$ are given in the problem statement, $P(B_0|D$, $P(B_1|D)$, and $P(B_2|D)$ are not. However, note that the probability that a white cat has two blue eyes given that it is deaf, $P(B_2|D)$, was calculated in part b. 

::: {.guidedpractice data-latex=""}

Calculate $P(B_0|D)$ and $P(B_1|D)$. [^probability-445]
:::

[^probability-445]: 
$$
P(B_0|D) = \frac{P(D \text{ and } B_0)}{P(D)} = \frac{P(D|B_0)P(B_0)}{P(D)} = \frac{(0.19)(0.60)}{0.307} = 0.371.
$$
$$
P(B_1|D) = \frac{P(D \text{ and } B_1)}{P(D)} = \frac{P(D|B_1)P(B_1)}{P(D)} = \frac{(0.40)(0.30)}{0.307} = 0.391.
$$

There is now enough information to calculate $P(L|D)$: 

\begin{align*}
P(L|D) =& P(L \text{ and } B_0|D) + P(L \text{ and } B_1 | D) + P(L \text{ and } B_2 |D) \\
=& P(L|D, B_0)P(B_0|D) + P(L|D, B_1)P(B_1|D) + P(L|D, B_2)P(B_2|D) \\
=& (0.20)(0.371) + (0.40)(0.391) + (0.20)(0.238) \\
=& 0.278.
\end{align*}

The prevalence of blindness among deaf, white cats is 0.278.

Part ii asks for the prevalence of blindness among white cats, $P(L)$. Again, partitioning is an effective strategy. Instead of partitioning by eye color, however, partition by deafness.

::: {.workedexample data-latex=""}

Calculate the prevalence of blindness among white cats, $P(L)$.

------------------------------------------------------------------------

\begin{align*}
P(L) =& P(L \text{ and } D) + P(L \text{ and } D^C) \\
=& P(L|D)P(D) + P(L|D^C)P(D^C) \\
=& (0.278)(0.307) + (0.10)(1 - 0.307) \\
=& 0.155.
\end{align*}	

$P(D)$ was calculated in part a), while $P(L|D)$ was calculated in part c, i. The conditional probability of blindness given a white cat is not deaf is 0.10, as given in the question statement. By the definition of the complement, $P(D^C) = 1 - P(D)$. 

The prevalence of blindness among white cats is 0.155.

:::

Part iii asks for the probability that a cat has two blue eyes, given that it is white and blind, $P(B_2|L)$. Since all cats being discussed in the problem are white, it is not necessary to condition on coat color.

Start out with the definition of conditional probability:
$$
P(B_2|L) = \dfrac{P(B_2 \text{ and } L)}{P(L)}. 
$$

The key to calculating $P(B_2|L)$ relies on recognizing that the event a cat is blind and has two blue eyes can be partitioned by whether or not the cat is also deaf:
$$
P(B_2|L) = \frac{P(B_2 \text{ and } L \text{ and } D) + P(B_2 \text{ and } L \text{ and } D^C)}{P(L)}.
$${#eq-pB2GivenL}

::: {.workedexample data-latex=""}

Draw a tree diagram to organize the events involved in this problem. Identify the branches that represent the possible paths for a white cat to both have two blue eyes and be blind. 

------------------------------------------------------------------------

When drawing a tree diagram, remember that each branch is conditioned on the previous branches. While there are various possible trees, the goal is to construct a tree for which as many of the branches as possible have known probabilities. 

The tree for this problem will have three branch points, corresponding to either deafness, blindness, or eye color. The first set of branches contain unconditional probabilities, the second set contains conditional probabilities given one event, and the third set contains conditional probabilities given two events.

Recall that the probabilities $P(L|D, B_0)$, $P(L|D, B_1)$, and $P(L|D, B_2)$ were provided in the problem statement. These are the only probabilities conditioned on two events that have previously appeared in the problem, so blindness is the most convenient choice of third branch point. 

It is not obvious whether it will be more efficient to start with deafness or eye color, since unconditional and conditional probabilities related to both have appeared in the problem. @fig-cat-genetics-trees shows two trees, figure (a) starting with deafness and (b) starting with eye color. The two possible paths for a white cat to both have two blue eyes and be blind are shown in green.

```{r}
#| label: fig-cat-genetics-trees
#| out-width: 80%
#| fig-cap: |
#|   Two tree diagrams for the cat genetics problem
#| fig-subcap: 
#|    - Tree beginning with first branch deafness
#|    - Tree beginning with first branch eye color
#| fig-alt: |
#|   draft alt caption here
#| fig-pos: H
#| layout-ncol: 2
knitr::include_graphics("images/catGeneticsTreesA.png")
knitr::include_graphics("images/catGeneticsTreesB.png")
```

:::

<!--- subfigure refs possible using markdown syntax for including figures.  Position of alt-text?

::: {#fig-example layout-ncol=2}

![Subfigure A caption.](fig-a.png){#fig-example-a}

![Subfigure B caption.](fig-b.png){#fig-example-b}

Main caption for the full figure.
:::

-->

::: {.workedexample data-latex=""}

Expand @eq-pB2GivenL according to the tree shown in @fig-cat-genetics-trees(a), and solve for $P(B_2|L)$.

------------------------------------------------------------------------

Two of the probabilities have not been calculated previously: $P(B_2|D^C)$ and $P(D^C)$. From the definition of the complement, $P(D^C) = 1 - P(D) = 0.693$; $P(D)$ was calculated in part a. To calculate $P(B_2|D^C)$, apply the definition of conditional probability as in part b, where $P(B_2|D)$ was calculated:
\begin{align*}
P(B_2|D^C) &= \dfrac{P(D^C \text{ and } B_2)}{P(D^C)} \\
           &= \dfrac{P(D^C|B_2)(P(B_2)}{P(D^C)} \\
           &= \dfrac{(1-0.73)(0.10)}{0.693} \\
           &= 0.0390.
\end{align*}

\begin{align*}
P(B_2|L) &= \dfrac{(0.20)(0.238)(0.307) + (0.10)(0.0390)(0.693)}{0.155} \\
&= 0.112
\end{align*}
	
The probability that a white cat has two blue eyes, given that it is blind, is 0.112.

:::

::: {.guidedpractice data-latex=""}

Expand @eq-pB2GivenL according to the tree shown in @fig-cat-genetics-trees(b), and solve for $P(B_2|L)$.  [^probability-446]
:::

[^probability-446]: 
\begin{align*}
P(B_2|L) &= \frac{P(L|B_2, D)P(D|B_2)P(B_2) + P(L|B_2, D^C)P(D^C|B_2)P(B_2)}{P(L)} \\             &=\frac{(0.20)(0.73)(0.10) + (0.10)(1-0.73)(0.10)}{0.155} \\
         &= 0.112.
\end{align*}

A tree diagram is useful for visualizing the different possible ways that a certain set of outcomes can occur. Although conditional probabilities can certainly be calculated without the help of tree diagrams, it is often easy to make errors with a strictly algebraic approach. Once a tree is constructed, it can be used to solve for several probabilities of interest. The following example shows how one of the previous trees can be applied to answer a different question than the one posed in part c, iii.

::: {.workedexample data-latex=""}

What is the probability that a white cat has one blue eye and one non-blue eye, given that it is not blind?

------------------------------------------------------------------------

Calculate $P(B_1|L^C)$. Start with the definition of conditional probability, then expand.

\begin{align*}
    P(B_1|L^C) &= \frac{P(B_1 \text{ and } L^C)}{P(L^C)} \\
    &= \frac{P(B_1 \text{ and } L^C \text{ and } D) + P(B_1 \text{ and } L^C \text{ and } D^C)}{P(L^C)}.
\end{align*}


@fig-cat-genetics-trees-c is a reproduction of the earlier @fig-cat-genetics-trees(b), with yellow arrows showing the two paths of interest.

As before, expand the numerator and fill in the known values.
	
\begin{align*}
	P(B_1|L^C) =& \frac{P(B_1 \text{ and } L^C \text{ and } D) + P(B_1 \text{ and } L^C \text{ and } D^C)}{P(L^C)}\\
	=& \frac{P(L^C|D, B_1)P(D|B_1)P(B_1) + P(L^C|D^C, B_1)P(D^C|B_1)P(B_1)}{P(L^C)} \\
	=& \frac{\textcolor{red}{\mathbf{P(L^C|D, B_1)}}(0.40)(0.30) + \textcolor{red}{\mathbf{P(L^C|D^C, B_1)P(D^C|B_1)}}(0.30)}{\textcolor{red}{\mathbf{P(L^C)}}}.
	\end{align*} 
	
The probabilities in [**red**]{style="color:red"} are not known. Apply the definition of the complement; recall that the rule for complements holds when an event and its complement are conditioned on the same information: $P(A|B) = 1 - P(A^C|B)$.
	
* $P(L^C) = 1 - P(L) = 1 - 0.155 = 0.845$
* $P(D^C|B_1) = 1 - P(D|B_1) = 1 - 0.40 = 0.60$
* $P(L^C|D, B_1) = 1 - P(L|D, B_1) = 1 - 0.40 = 0.60$

	
	The definition of the complement can also be applied to calculate $P(L^C|D^C, B_1)$. The problem statement originally specified that white cats that are not deaf have probability 0.10 of developing blindness regardless of eye color: $P(L|D^C) = 0.10$. Thus, $P(L^C|D^C, B_1) = P(L^C|D^C)$. By the definition of the complement, $P(L^C|D^C) = 1 - P(L|D^C) = 1 - 0.10 = 0.90$.
	
\begin{align*}
	P(B_1|L^C) =& \frac{P(B_1 \text{ and } L^C \text{ and } D) + P(B_1 \text{ and } L^C \text{ and } D^C)}{P(L^C)}\\
	=& \frac{P(L^C|D, B_1)P(D|B_1)P(B_1) + P(L^C|D^C, B_1)P(D^C|B_1)P(B_1)}{P(L^C)} \\
	=& \frac{(0.60)(0.40)(0.30) + (0.90)(0.60)(0.30)}{0.845} \\
	=& 0.277.
\end{align*} 
	
The probability that a white cat has one blue eye and one non-blue eye, given that it is not blind, is 0.277.

```{r fig-cat-genetics-c}
#| label: fig-cat-genetics-trees-c
#| out-width: 80%
#| fig-cap: |
#|   The two possible paths for a white cat to both have one blue eye (and one non-blue eye) and to not be blind are shown in yellow.
#| fig-alt: |
#|   draft alt caption here
#| fig-pos: H
#| layout-ncol: 1
knitr::include_graphics("images/catGeneticsTreesC.png")

```


:::

## Chapter review {#sec-chp3-review}

### Summary

Probability is an essential tool for quantifying uncertainty, and conditional probability may be the most important idea in the chapter.  If I test positive for a disease, how likely is it that I have the condition?  How do the rules of probability govern the genetic makeup of a child from based on the information in genetic screening of the parents?  

Probability calculations can be difficult, but they become easier when guided by some of the tools discussed here, such as Venn diagrams, tree diagrams or contingency tables that mirror the characteristics of population.



```{r}
#| label: tbl-terms-chp-3
#| tbl-cap: Terms introduced in this chapter.
#| tbl-pos: H
make_terms_table(terms_chp_3)
```

\clearpage

## Exercises {#sec-chp3-exercises}

The exercises are not numbered yet and no solutions are available in this draft.

::: {.exercises data-latex=""}
{{< include exercises/_03-ex-probability.qmd >}}
:::
